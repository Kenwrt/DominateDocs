@page "/loantypelist"

@using DominateDocsData.Models.DTOs
@using MudBlazor

@rendermode InteractiveServer
@inject DominateDocsSite.ViewModels.LoanTypeListViewModel vm
@inject ISnackbar Snackbar

<MudGrid Class="mb-10">

    @if (!AddEdit)
    {
        <MudItem xs="12" md="12">
            <MudTable T="LoanTypeListDTO"
                      Items="FilteredList"
                      Hover="true"
                      Bordered="true"
                      Dense="true"
                      @bind-SelectedItem="vm.SelectedRecord"
                      RowClick="OnRowClick">

                <ToolBarContent>
                    <MudTextField @bind-Value="searchString"
                                  Placeholder="Search..."
                                  Immediate="true" />
                </ToolBarContent>

                <HeaderContent>
                    <MudTh>Name</MudTh>
                    <MudTh>Description</MudTh>
                    <MudTh>Icon</MudTh>
                    <MudTh>
                        <MudButton Class="rounded-4"
                                   Disabled="@AddButtonDisabled"
                                   Variant="Variant.Text"
                                   Size="Size.Small"
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.Add"
                                   OnClick="AddButton">
                            Add Loan Type
                        </MudButton>
                    </MudTh>
                </HeaderContent>

                <RowTemplate>
                    <MudTd DataLabel="Name">@context.Name</MudTd>
                    <MudTd DataLabel="Description">@context.Description</MudTd>
                    <MudTd DataLabel="Icon">@context.IconKey</MudTd>
                    <MudTd>
                        <MudButton Variant="Variant.Text"
                                   Size="Size.Small"
                                   Color="Color.Info"
                                   StartIcon="@Icons.Material.Filled.Edit"
                                   OnClick="@(() => Edit(context))">
                            Edit
                        </MudButton>

                        <MudButton Variant="Variant.Text"
                                   Size="Size.Small"
                                   Color="Color.Error"
                                   StartIcon="@Icons.Material.Filled.Delete"
                                   OnClick="@(() => OnDeleteRecord(context))">
                            Delete
                        </MudButton>
                    </MudTd>
                </RowTemplate>

                <NoRecordsContent>
                    <MudText Color="Color.Secondary" Class="pa-4">
                        🚫 No Loan Types Found. Please add!
                    </MudText>
                </NoRecordsContent>

            </MudTable>
        </MudItem>
    }
    else
    {
        <MudItem xs="12" md="12">
            <MudPaper Elevation="1" Class="mt-5" Style="background-color: #F2F2F2;">
                <br />
                <MudText Class="pl-4 mt-5" Typo="Typo.h5">Loan Type</MudText>

                <LoanTypeCreate OnLoanTypeComplete="OnLoanTypeComplete"
                                OnLoanTypeCancel="OnLoanTypeCancel"
                                SelectedLoanType="vm.SelectedRecord" />
            </MudPaper>
        </MudItem>
    }

</MudGrid>

@code
{
    private bool AddEdit = false;
    private bool AddButtonDisabled = false;
    private string searchString = "";

    private IEnumerable<LoanTypeListDTO> FilteredList =>
        string.IsNullOrWhiteSpace(searchString)
            ? vm.RecordList
            : vm.RecordList.Where(l =>
                (!string.IsNullOrWhiteSpace(l.Name) && l.Name.Contains(searchString, StringComparison.OrdinalIgnoreCase)) ||
                (!string.IsNullOrWhiteSpace(l.Description) && l.Description.Contains(searchString, StringComparison.OrdinalIgnoreCase)));

    protected override void OnInitialized()
    {
        vm.InitializePageCommand.Execute(null);
    }

    private void AddButton()
    {
        vm.GetNewRecordCommand.Execute(null);
        AddEdit = true;
        AddButtonDisabled = true;
    }

    private void Edit(LoanTypeListDTO dto)
    {
        vm.SelectRecordCommand.Execute(dto);
        AddEdit = true;
    }

    private void OnRowClick(TableRowClickEventArgs<LoanTypeListDTO> args)
    {
        if (args.Item is null) return;
        vm.SelectRecordCommand.Execute(args.Item);
        AddEdit = true;
    }

    private void OnDeleteRecord(LoanTypeListDTO dto)
    {
        vm.DeleteRecordCommand.Execute(dto);
        AddEdit = false;
        StateHasChanged();
    }

    private void OnLoanTypeComplete(DominateDocsData.Models.LoanType _)
    {
        AddEdit = false;
        AddButtonDisabled = false;

        vm.InitializePageCommand.Execute(null);
        StateHasChanged();
    }

    private void OnLoanTypeCancel()
    {
        AddEdit = false;
        AddButtonDisabled = false;

        vm.ClearSelectionCommand.Execute(null);
        StateHasChanged();
    }
}
