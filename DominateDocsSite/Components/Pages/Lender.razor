@using System.Text
@using Blazored.FluentValidation
@using DominateDocsData.Models
@using DominateDocsData.Enums
@using System.Globalization
@using DominateDocsSite.State
@using MudBlazor
@using System.Threading

@rendermode InteractiveServer

@inject LenderViewModel vm
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject LenderValidator LenderValidator
@inject SigningAuthorityValidator SigningAuthorityValidator
@inject AliasValidator AliasValidator
@inject EntityOwnerValidator EntityOwnerValidator
@inject UserSession Session

@* <style>
    /* ===== Fix MudSelect fill corners (it uses DIVs, not INPUTs) ===== */

    /* The visible select surface */
    .form-skin .mud-select .mud-select-input,
    .form-skin .mud-select .mud-input-slot {
        background-color: #fff !important;
        border-radius: 12px !important;
    }

    /* Clip the inner slot so the white fill obeys rounding */
    .form-skin .mud-select .mud-select-input {
        overflow: hidden !important;
    }

    /* Keep the outlined border matching */
    .form-skin .mud-select .mud-input-outlined,
    .form-skin .mud-select .mud-input-outlined .mud-input-outlined-border {
        border-radius: 12px !important;
    }

        /* Fix notch background on selects */
        .form-skin .mud-select .mud-input-outlined legend span,
        .form-skin .mud-select .mud-input-outlined .mud-input-label {
            background-color: #fff !important;
            padding: 0 4px;
        }

</style> *@





@if (!string.IsNullOrEmpty(searchString))
{
    <MudText class="pl-4 mt-5" Typo="Typo.h6">Existing Lenders</MudText>

    <MudTable Items="FilteredLenders"
              Hover="true"
              Bordered="true"
              Dense="true"
              @bind-SelectedItem="vm.SelectedRecord"
              RowClick="OnSelectedRecord">
        <ToolBarContent>
            <MudTextField @bind-Value="searchString"
                          Placeholder="Search..."
                          Immediate="true" />
        </ToolBarContent>
        <HeaderContent>
            <MudTh>Entity Name</MudTh>
            <MudTh>Address</MudTh>
            <MudTh>Phone</MudTh>
            <MudTh>Email</MudTh>
            <MudTh>Active</MudTh>
            <MudTh>
                <MudButton Class="rounded-4"
                           Variant="Variant.Text"
                           Size="Size.Small"
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.ArrowBack"
                           OnClick="SearchBackAsync">
                    Back
                </MudButton>
            </MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Enitity Name">@context.EntityName</MudTd>
            <MudTd DataLabel="Address">@context.FullAddress</MudTd>
            <MudTd DataLabel="Phone">@context.ContactPhoneNumber</MudTd>
            <MudTd DataLabel="Email">@context.ContactEmail</MudTd>
            <MudTd DataLabel="Active">
                <MudChip T="bool" Color="@((context.IsActive) ? Color.Success : Color.Error)">
                    @(context.IsActive ? "Yes" : "No")
                </MudChip>
            </MudTd>
            <MudTd>
                <MudButton Class="rounded-4"
                           Variant="Variant.Text"
                           Size="Size.Small"
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.ArrowBack"
                           OnClick="@(() => OnSelectedRecord(context))">
                    Add Lender
                </MudButton>
            </MudTd>
        </RowTemplate>
        <NoRecordsContent>
            <MudText Color="Color.Secondary" Class="pa-4">
                🚫 No Active Lenders Found. Please add!
            </MudText>
        </NoRecordsContent>
    </MudTable>
}
else
{

    <MudTextField T="string"
                  @bind-Value="searchString"
                  Immediate="true"
                  Placeholder="Search for Existing Lenders"
                  Adornment="Adornment.Start"
                  AdornmentIcon="@Icons.Material.Filled.Search"
                  IconSize="Size.Medium"
                  Class="pa-4 mt-5 form-skin" />

    <MudForm Context="contextLender"
             Model="@vm.EditingRecord"
             @ref="@formEditRecord"
             Validation="@LenderValidator"
             ValidationDelay="0" Class="form-skin">

       @*  <div class="form-skin"> *@

            <MudGrid GutterSize="3">

                <MudItem md="4">
                    <div class="d-flex flex-column gap-2">
                        <MudSelect Class="ml-4 mt-7" T="DominateDocsData.Enums.Entity.Types" Variant="Variant.Outlined" Label="Select Entity Type" @bind-Value="vm.EditingRecord.EntityType" Dense="true">

                            @foreach (var gt in Enum.GetValues<DominateDocsData.Enums.Entity.Types>())
                            {
                                <MudSelectItem T="DominateDocsData.Enums.Entity.Types"
                                               Value="gt">@gt.GetDescription()</MudSelectItem>
                            }

                        </MudSelect>

                        @if (vm.EditingRecord.EntityType == DominateDocsData.Enums.Entity.Types.Entity)
                        {
                            <MudTextField Class="pl-4" Variant="Variant.Outlined" @bind-Value="vm.EditingRecord.EntityName" For="@(() => vm.EditingRecord.EntityName)" Label="Entity Name" Required="true" />

                            <MudSelect Class="ml-4"
                                       T="DominateDocsData.Enums.Entity.Structures"
                                       Variant="Variant.Outlined"
                                       Label="Select Entity Structure"
                                       @bind-Value="vm.EditingRecord.EntityStructure"
                                       Dense="true">

                                @foreach (var gt in Enum.GetValues<DominateDocsData.Enums.Entity.Structures>())
                                {
                                    <MudSelectItem T="DominateDocsData.Enums.Entity.Structures"
                                                   Value="gt">@gt.GetDescription()</MudSelectItem>
                                }

                            </MudSelect>

                            <MudSelect Class="ml-4"
                                       T="DominateDocsData.Enums.UsStates.UsState"
                                       Variant="Variant.Outlined"
                                       Label="Select State of Incorporation"
                                       @bind-Value="vm.EditingRecord.StateOfIncorporation"
                                       Dense="true">

                                @foreach (var tr in Enum.GetValues<DominateDocsData.Enums.UsStates.UsState>())
                                {
                                    <MudSelectItem Variant="Variant.Outlined" T="DominateDocsData.Enums.UsStates.UsState" Value="tr">@tr.GetDescription()</MudSelectItem>
                                }

                            </MudSelect>

                            <MudTextField Class="pl-4"
                                          Variant="Variant.Outlined"
                                          @bind-Value="vm.EditingRecord.EIN"
                                          Label="EIN#"
                                          Required="false" />

                            <MudTextField Class="pl-4"
                                          Variant="Variant.Outlined"
                                          @bind-Value="vm.EditingRecord.ContactName"
                                          For="@(() => vm.EditingRecord.ContactName)"
                                          Label="Contact Name"
                                          Required="true" />

                            <MudSelect Class="ml-4"
                                       T="DominateDocsData.Enums.Entity.ContactRoles"
                                       Variant="Variant.Outlined"
                                       Label="Contact's Role"
                                       @bind-Value="vm.EditingRecord.ContactsRole"
                                       Dense="true">

                                @foreach (var gt in Enum.GetValues<DominateDocsData.Enums.Entity.ContactRoles>())
                                {
                                    <MudSelectItem T="DominateDocsData.Enums.Entity.ContactRoles"
                                                   Value="gt">@gt.GetDescription()</MudSelectItem>
                                }

                            </MudSelect>

                            <MudTextField Class="pl-4"
                                          @bind-Value="vm.EditingRecord.ContactEmail"
                                          Variant="Variant.Outlined"
                                          Label="Contact Email"
                                          Placeholder="example@domain.com"
                                          Required="true"
                                          RequiredError="Email is required"
                                          Pattern="@emailPattern"
                                          PatternErrorMessage="Invalid email format"
                                          Immediate="true" />

                            <MudTextField Label="Contact Phone"
                                          Class="pl-4"
                                          Variant="Variant.Outlined"
                                          @bind-Value="vm.EditingRecord.ContactPhoneNumber"
                                          Mask="@phoneMask"
                                          Placeholder="(___) ___-____"
                                          Required="true"
                                          Immediate="true" />
                        }
                        else
                        {
                            <MudTextField Class="pl-4"
                                          Variant="Variant.Outlined"
                                          @bind-Value="vm.EditingRecord.ContactName"
                                          For="@(() => vm.EditingRecord.ContactName)"
                                          Label="ContactName"
                                          Required="true" />

                            <MudTextField Class="pl-4"
                                          @bind-Value="vm.EditingRecord.ContactEmail"
                                          Variant="Variant.Outlined"
                                          Label="Contact Email"
                                          Placeholder="example@domain.com"
                                          Required="true"
                                          RequiredError="Email is required"
                                          Pattern="@emailPattern"
                                          PatternErrorMessage="Invalid email format"
                                          Immediate="true" />

                            <MudTextField Label="Contact Phone"
                                          Class="pl-4"
                                          Variant="Variant.Outlined"
                                          @bind-Value="vm.EditingRecord.ContactPhoneNumber"
                                          Mask="@phoneMask"
                                          Placeholder="(___) ___-____"
                                          Required="true"
                                          Immediate="true" />
                        }

                        <AddressCompleteMap OnAddressChange="OnAddressComplete"
                                            Row="false"
                                            MultipleAddress="false"
                                            AddressList="@addresDTOList" DisplayMap="false" />
                    </div>
                </MudItem>

                <MudItem md="4">
                    <div class="d-flex flex-column gap-2">
                        @if (vm.EditingRecord.EntityType == Entity.Types.Individual)
                        {
                            <MudTextField Class="pl-4 mt-7 mr-5"
                                          @bind-Value="vm.EditingRecord.SSN"
                                          Variant="Variant.Outlined"
                                          For="@(() => vm.EditingRecord.SSN)"
                                          Label="SSN"
                                          Mask="@socialMask"
                                          Placeholder="___-__-____"
                                          Required="true"
                                          RequiredError="SSN is required"
                                          Pattern="^\d{3}-\d{2}-\d{4}$"
                                          PatternErrorMessage="Invalid SSN format" />

                            <MudSelect Class="ml-4 mr-5"
                                       T="DominateDocsData.Enums.UsStates.UsState"
                                       Variant="Variant.Outlined"
                                       Label="State Choice of Law"
                                       @bind-Value="vm.EditingRecord.PreferredStateVenue"
                                       Dense="true">

                                @foreach (var tr in Enum.GetValues<DominateDocsData.Enums.UsStates.UsState>())
                                {
                                    <MudSelectItem T="DominateDocsData.Enums.UsStates.UsState"
                                                   Value="tr">@tr.GetDescription()</MudSelectItem>
                                }

                            </MudSelect>


                        }
                        else
                        {
                            <MudSelect Class="ml-4 mr-5 mt-7"
                                       T="DominateDocsData.Enums.UsStates.UsState"
                                       Variant="Variant.Outlined"
                                       Label="State Choice of Law"
                                       @bind-Value="vm.EditingRecord.PreferredStateVenue"
                                       Dense="true">

                                @foreach (var tr in Enum.GetValues<DominateDocsData.Enums.UsStates.UsState>())
                                {
                                    <MudSelectItem T="DominateDocsData.Enums.UsStates.UsState"
                                                   Value="tr">@tr.GetDescription()</MudSelectItem>
                                }

                            </MudSelect>
                        }

                        @*  <MudTextField Class="pl-4 mr-5"
                                        Variant="Variant.Outlined"
                                        Style="background-color: white;"
                                        @bind-Value="vm.EditingRecord.RegulatoryAuthority"
                                        For="@(() => vm.EditingRecord.RegulatoryAuthority)"
                                        Label="Regulatory Authority"
                                        Required="false" /> *@

                        <MudNumericField Class="pl-4 mr-5"
                                         HideSpinButtons="true"
                                         Adornment="Adornment.Start"
                                         AdornmentText="$"
                                         Culture="CultureInfo.InvariantCulture"
                                         Format="N2"
                                         @bind-Value="vm.EditingRecord.InvestmentAmount"
                                         Label="Investment Amount"
                                         Variant="Variant.Outlined"
                                         Step=".2M" />

                        @if (vm.EditingRecord.EntityType == DominateDocsData.Enums.Entity.Types.Entity)
                        {
                            <EntityOwner OnEntityOwnerComplete="OnEntityOwnerComplete"
                                         OnEntityOwnerCanceled="OnEntityOwnerCanceled"
                                         OwnerList="@vm.EditingRecord.EntityOwners" />
                        }

                        <MudTextField Class="pl-4 mr-5"
                                      Variant="Variant.Outlined"
                                      @bind-Value="vm.EditingRecord.NmlsLicenseNumber"
                                      Color="Color.Primary"
                                      For="@(() => vm.EditingRecord.NmlsLicenseNumber)"
                                      Label="NMLS License Number" />

                        <MudSwitch Class="pl-4 pr-4" T="bool" @bind-Value="vm.EditingRecord.IsStateLicense" Color="Color.Primary">State Lending Licenses(@(vm.EditingRecord.StateLicenses?.Count ?? 0))</MudSwitch>

                        @if (vm.EditingRecord.IsStateLicense)
                        {
                            <StateLendingLicense OnStateLicenseComplete="OnStateLicenseComplete"
                                                 OnStateLicenseCanceled="OnStateLicenseCanceled"
                                                 StateLicenseList="@vm.EditingRecord.StateLicenses" />
                        }

                    </div>
                </MudItem>

                <MudItem md="4">
                    <div class="d-flex flex-column gap-2">



                        <MudSwitch Class="pl-4 pr-4 mt-7"
                                   T="bool"
                                   @bind-Value="vm.EditingRecord.IsAliasNamesUsed"
                                   Color="Color.Primary">Alias Names(@(vm.EditingRecord.AliasNames?.Count ?? 0))</MudSwitch>

                        @if (vm.EditingRecord.IsAliasNamesUsed)
                        {
                            <AkaAlias OnAliasComplete="OnAliasComplete"
                                      OnAliasCanceled="OnAliasCanceled"
                                      AliasList="@vm.EditingRecord.AliasNames" />
                        }

                        <MudSwitch Class="pl-4 pr-4"
                                   T="bool"
                                   @bind-Value="vm.EditingRecord.IsSignatureAuthority"
                                   Color="Color.Primary">Signature Authority Names(@(vm.EditingRecord.SigningAuthorities?.Count ?? 0))</MudSwitch>

                        @if (vm.EditingRecord.IsSignatureAuthority)
                        {
                            <SignatureAuthority OnSigningAuthorityComplete="OnSigningAuthorityComplete"
                                                OnSigningAuthorityCanceled="OnSigningAuthorityCanceled"
                                                SigningAuthorityList="@vm.EditingRecord.SigningAuthorities" />
                        }

                        <MudSwitch Class="pl-4"
                                   T="bool"
                                   @bind-Value="vm.EditingRecord.IsLanuageTranslatorRequired"
                                   Color="Color.Primary"
                                   Label="Requires Translator" />
                        <MudSwitch Class="pl-4"
                                   T="bool"
                                   @bind-Value="vm.EditingRecord.IsAForgeinNational"
                                   Color="Color.Primary"
                                   Label="Forgein National" />

                       
                        <MudGrid Justify="Justify.Center"
                                 AlignItems="AlignItems.Center"
                                 Class="mt-4">
                            <MudItem md="3">
                                <MudButton Type="Submit"
                                           OnClick="HandleSubmit"
                                           Color="Color.Success"
                                           Variant="Variant.Filled">
                                    @(!editRecord ? "Add" : "Save")
                                </MudButton>
                            </MudItem>
                            <MudItem md="3">
                                <MudButton OnClick="ClearSelection"
                                           Color="Color.Secondary"
                                           Variant="Variant.Filled">
                                    Clear
                                </MudButton>
                            </MudItem>
                        </MudGrid>


                    </div>
                </MudItem>

            </MudGrid>
        @* </div> *@
    </MudForm>

}

@code
{
    [Parameter] public EventCallback<DominateDocsData.Models.Lender> OnLenderComplete { get; set; }
    [Parameter] public EventCallback OnLenderCancel { get; set; }
    [Parameter] public bool AllowRecordEdit { get; set; } = false;
    [Parameter] public DominateDocsData.Models.Lender SelectedLender { get; set; } = null;

    private bool AddEdit = false;

    private bool editRecord = false;

    private readonly PatternMask phoneMask = new("(000)000-0000");
    private readonly PatternMask socialMask = new("000-00-0000");

    private MudForm formEditRecord;

    private List<AddressDTO> addresDTOList = new();

    private string searchString = "";

    // Filtered view of the lenders based on searchString
    private IEnumerable<DominateDocsData.Models.Lender> FilteredLenders =>
        string.IsNullOrWhiteSpace(searchString)
            ? vm.RecordList
            : vm.RecordList.Where(l =>
                   (!string.IsNullOrEmpty(l.EntityName) &&
                    l.EntityName.Contains(searchString, StringComparison.OrdinalIgnoreCase))
                || (!string.IsNullOrEmpty(l.FullAddress) &&
                    l.FullAddress.Contains(searchString, StringComparison.OrdinalIgnoreCase))
                || (!string.IsNullOrEmpty(l.ContactPhoneNumber) &&
                    l.ContactPhoneNumber.Contains(searchString, StringComparison.OrdinalIgnoreCase))
                || (!string.IsNullOrEmpty(l.ContactEmail) &&
                    l.ContactEmail.Contains(searchString, StringComparison.OrdinalIgnoreCase)));

    private string emailPattern = @"^[\w\-\.]+@([\w\-]+\.)+[\w\-]{2,4}$";

    private bool AddButtonDisabled = false;

    protected override async Task OnInitializedAsync()
    {

        vm.InitializePageCommand.Execute(SelectedLender);

        if (SelectedLender is not null)
        {
            editRecord = true;
        }

        if (!string.IsNullOrEmpty(vm.EditingRecord.FullAddress))
        {
            AddressDTO dto = new()
            {
                FullAddress = vm.EditingRecord.FullAddress,
                StreetAddress = vm.EditingRecord.StreetAddress,
                State = vm.EditingRecord.State,
                City = vm.EditingRecord.City,
                ZipCode = vm.EditingRecord.ZipCode,
                County = vm.EditingRecord.County,
                Country = vm.EditingRecord.Country,
                Lat = vm.EditingRecord.Lat,
                Lng = vm.EditingRecord.Lng
            };
            addresDTOList.Add(dto);
        }



    }

    private async Task SearchBackAsync()
    {
        searchString = "";

    }

    private async Task HandleSubmit()
    {
        await formEditRecord.Validate();

        if (!formEditRecord.IsValid)
        {
            Snackbar.Add("Please correct the errors in the form.", Severity.Error);
            return;
        }
        else
        {
            if (!editRecord)
            {

                if (vm.RecordList.Any(x => (x.SSN == vm.EditingRecord.SSN && vm.EditingRecord.SSN != null) || (x.EIN == vm.EditingRecord.EIN && vm.EditingRecord.EIN != null)))
                {

                    Snackbar.Add("A Lender already exists choose from the list of Lenders.", Severity.Error);
                    return;
                }
            }

            vm.UpsertRecordCommand.Execute(null);

            await OnLenderComplete.InvokeAsync(vm.EditingRecord);

            AddButtonDisabled = false;

            editRecord = false;

            vm.GetNewRecordCommand.Execute(null);

            StateHasChanged();
        }
    }

    private async Task AddLenderForEditAsync(DominateDocsData.Models.Lender r)
    {
        if (AllowRecordEdit)
        {
            vm.EditingRecord = r;
            searchString = "";
            AddButtonDisabled = false;
            editRecord = true;
        }


        StateHasChanged();
    }

    private async Task SearchBack()
    {
        searchString = "";

        StateHasChanged();
    }

    private void ClearSelection()
    {
        vm.ClearSelectionCommand.Execute(null);
        vm.EditingRecord = new DominateDocsData.Models.Lender();
        StateHasChanged();
    }

    private void AddButton()
    {
        vm.GetNewRecordCommand.Execute(null);

        editRecord = true;
        AddEdit = true;
        AddButtonDisabled = true;
    }

    private void OnSelectedRecord(DominateDocsData.Models.Lender lender)
    {
        searchString = "";

        vm.SelectRecordCommand.Execute(lender);

        editRecord = true;

        AddEdit = true;
    }

    private void OnAddressComplete(List<AddressDTO> addressList)
    {
        if (addressList == null || addressList.Count == 0)
        {
            vm.EditingRecord.FullAddress = string.Empty;
            vm.EditingRecord.StreetAddress = string.Empty;
            vm.EditingRecord.City = string.Empty;
            vm.EditingRecord.State = string.Empty;
            vm.EditingRecord.ZipCode = string.Empty;
            vm.EditingRecord.County = string.Empty;
            vm.EditingRecord.Country = string.Empty;
        }
        else
        {
            var addressDTO = addressList.FirstOrDefault();

            vm.EditingRecord.FullAddress = addressDTO.FullAddress;
            vm.EditingRecord.StreetAddress = addressDTO.StreetAddress;
            vm.EditingRecord.City = addressDTO.City;
            vm.EditingRecord.State = addressDTO.State;
            vm.EditingRecord.ZipCode = addressDTO.ZipCode;
            vm.EditingRecord.County = addressDTO.County;
            vm.EditingRecord.Country = addressDTO.Country;
            vm.EditingRecord.Lat = addressDTO.Lat;
            vm.EditingRecord.Lng = addressDTO.Lng;
        }
    }

    private async Task OnEntityOwnerComplete(List<DominateDocsData.Models.EntityOwner> entityOwners)
    {
        vm.EditingRecord.EntityOwners = entityOwners;
    }

    private async Task OnEntityOwnerCanceled()
    {
        StateHasChanged();
    }

    private async Task OnSigningAuthorityComplete(List<DominateDocsData.Models.SigningAuthority> signers)
    {
        vm.EditingRecord.SigningAuthorities = signers;
    }

    private async Task OnSigningAuthorityCanceled()
    {
        StateHasChanged();
    }

    private async Task OnAliasComplete(List<DominateDocsData.Models.AkaName> alias)
    {
        vm.EditingRecord.AliasNames = alias;
    }

    private async Task OnAliasCanceled()
    {
        StateHasChanged();
    }

    private async Task OnStateLicenseComplete(List<DominateDocsData.Models.StateLendingLicense> r)
    {
        vm.EditingRecord.StateLicenses = r;
    }

    private async Task OnStateLicenseCanceled()
    {

    }
}
