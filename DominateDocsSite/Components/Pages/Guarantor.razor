
@using System.Text
@using DominateDocsData.Models
@using DominateDocsData.Enums
@using System.Globalization

@rendermode InteractiveServer
@inject GuarantorViewModel vm
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject GuarantorValidator GuarantorValidator
@inject SigningAuthorityValidator SigningAuthorityValidator
@inject AliasValidator AliasValidator
@inject EntityOwnerValidator EntityOwnerValidator
@inject UserSession Session


@if (searchString != "")
{
        <MudText class="pl-4 mt-5" Typo="Typo.h6">Existing Guarantors</MudText>
        <MudTable Items="FilteredList"
                  Hover="true"
                  Bordered="true"
                  Dense="true"
                  @bind-SelectedItem="vm.SelectedRecord"
                  RowClick="OnSelectedRecord">
            <ToolBarContent>
                <MudTextField @bind-Value="searchString"
                              Placeholder="Search..."
                              Immediate="true" />
            </ToolBarContent>
            <HeaderContent>
                <MudTh>Entity Name</MudTh>
                <MudTh>Address</MudTh>
                <MudTh>Phone</MudTh>
                <MudTh>Email</MudTh>
                <MudTh>Active</MudTh>
                <MudTh>
                <MudButton Class="rounded-4"
                           Variant="Variant.Text"
                           Size="Size.Small"
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.ArrowBack"
                           OnClick="SearchBackAsync">
                    Back
                </MudButton>
           
                </MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Enitity Name">@context.EntityName</MudTd>
                <MudTd DataLabel="Address">@context.FullAddress</MudTd>
                <MudTd DataLabel="Phone">@context.ContactPhoneNumber</MudTd>
                <MudTd DataLabel="Email">@context.ContactEmail</MudTd>
                <MudTd DataLabel="Active">
                    <MudChip T="bool" Color="@((context.IsActive) ? Color.Success : Color.Error)">
                        @(context.IsActive ? "Yes" : "No")
                    </MudChip>
                </MudTd>
                <MudTd>
                    <MudButton Class="rounded-4"
                               Variant="Variant.Text"
                               Size="Size.Small"
                               Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.Add"
                               OnClick="@(() => OnSelectedRecord(context))">
                        Add Guarantor
                    </MudButton>
                  </MudTd>
               
            </RowTemplate>
            <NoRecordsContent>
                <MudText Color="Color.Secondary" Class="pa-4">
                    🚫 No Active Guarantors Found. Please add!
                </MudText>
            </NoRecordsContent>
        </MudTable>
}
else
{
    
        <MudTextField @bind-Value="searchString"
                      Placeholder="Search..."
                      Immediate="true" />

    <MudItem xs="12" Class="mt-3 mb-3 ml-5">
        <MudText Typo="Typo.h5">Guarantor</MudText>

    </MudItem>

        <MudForm Context="contextGurantor" Model="@vm.EditingRecord" @ref="@formEditRecord" Validation="@GuarantorValidator" ValidationDelay="0">
            <MudGrid GutterSize="3">
                <MudItem md="4">
                    <div class="d-flex flex-column gap-2">
                            <MudSelect Class="ml-4 mt-7" T="DominateDocsData.Enums.GuarantorPosition.Types" Style="" Variant="Variant.Outlined" Label="Select Guarantor Type" @bind-Value="vm.EditingRecord.GuarantorType" Dense="true">

                                @foreach (var gt in Enum.GetValues<DominateDocsData.Enums.GuarantorPosition.Types>())
                            {
                                    <MudSelectItem Style="" T="DominateDocsData.Enums.GuarantorPosition.Types" Value="gt">@gt.GetDescription()</MudSelectItem>
                            }

                        </MudSelect>
                            <MudSelect Class="ml-4" T="DominateDocsData.Enums.Entity.Types" Style="" Variant="Variant.Outlined" Label="Select Entity Type" @bind-Value="vm.EditingRecord.EntityType" Dense="true">

                                @foreach (var gt in Enum.GetValues<DominateDocsData.Enums.Entity.Types>())
                                {
                                    <MudSelectItem Style="" T="DominateDocsData.Enums.Entity.Types" Value="gt">@gt.GetDescription()</MudSelectItem>
                                }

                            </MudSelect>

                            @if (vm.EditingRecord.EntityType == DominateDocsData.Enums.Entity.Types.Entity)
                            {
                                <MudTextField Class="pl-4" Style="" Variant="Variant.Outlined" @bind-Value="vm.EditingRecord.EntityName" For="@(() => vm.EditingRecord.EntityName)" Label="Entity Name" Required="true" />

                                <MudSelect Class="ml-4" T="DominateDocsData.Enums.Entity.Structures" Style="" Variant="Variant.Outlined" Label="Select Entity Structure" @bind-Value="vm.EditingRecord.EntityStructure" Dense="true">

                                    @foreach (var gt in Enum.GetValues<DominateDocsData.Enums.Entity.Structures>())
                                    {
                                        <MudSelectItem Style="" T="DominateDocsData.Enums.Entity.Structures" Value="gt">@gt.GetDescription()</MudSelectItem>
                                    }

                                </MudSelect>

                                <MudSelect Class="ml-4" T="DominateDocsData.Enums.UsStates.UsState" Style="" Variant="Variant.Outlined" Label="Select State of Incorporation" @bind-Value="vm.EditingRecord.StateOfIncorporation" Dense="true">

                                    @foreach (var tr in Enum.GetValues<DominateDocsData.Enums.UsStates.UsState>())
                                    {
                                        <MudSelectItem Style="" T="DominateDocsData.Enums.UsStates.UsState" Value="tr">@tr.GetDescription()</MudSelectItem>
                                    }

                                </MudSelect>


                                <MudTextField Class="pl-4" Style="" Variant="Variant.Outlined" @bind-Value="vm.EditingRecord.EIN" Label="EIN#" Required="false" />
                                <MudTextField Class="pl-4" Style="" Variant="Variant.Outlined" @bind-Value="vm.EditingRecord.ContactName" For="@(() => vm.EditingRecord.ContactName)" Label="Contact Name" Required="true" />

                                <MudSelect Class="ml-4" T="DominateDocsData.Enums.Entity.ContactRoles" Style="" Variant="Variant.Outlined" Label="Contact's Role" @bind-Value="vm.EditingRecord.ContactsRole" Dense="true">

                                    @foreach (var gt in Enum.GetValues<DominateDocsData.Enums.Entity.ContactRoles>())
                                    {
                                        <MudSelectItem Style="" T="DominateDocsData.Enums.Entity.ContactRoles" Value="gt">@gt.GetDescription()</MudSelectItem>
                                    }

                                </MudSelect>


                                <MudTextField Class="pl-4" @bind-Value="vm.EditingRecord.ContactEmail" Style="" Variant="Variant.Outlined"
                                              Label="Contact Email"
                                              Placeholder="example@domain.com"
                                              Required="true"
                                              RequiredError="Email is required"
                                              Pattern="@emailPattern"
                                              PatternErrorMessage="Invalid email format"
                                              Immediate="true" />


                                <MudTextField Label="Contact Phone" Class="pl-4" Style="" Variant="Variant.Outlined"
                                              @bind-Value="vm.EditingRecord.ContactPhoneNumber"
                                              Mask="@phoneMask"
                                              Placeholder="(___) ___-____"
                                              Required="true"
                                              Immediate="true" />

                        
                            }
                            else
                            {
                                <MudTextField Class="pl-4" Style="" Variant="Variant.Outlined" @bind-Value="vm.EditingRecord.ContactName" For="@(() => vm.EditingRecord.ContactName)" Label="ContactName" Required="true" />



                                <MudTextField Class="pl-4" @bind-Value="vm.EditingRecord.ContactEmail" Style="" Variant="Variant.Outlined"
                                              Label="Contact Email"
                                              Placeholder="example@domain.com"
                                              Required="true"
                                              RequiredError="Email is required"
                                              Pattern="@emailPattern"
                                              PatternErrorMessage="Invalid email format"
                                              Immediate="true" />


                                <MudTextField Label="Contact Phone" Class="pl-4" Style="" Variant="Variant.Outlined"
                                              @bind-Value="vm.EditingRecord.ContactPhoneNumber"
                                              Mask="@phoneMask"
                                              Placeholder="(___) ___-____"
                                              Required="true"
                                              Immediate="true" />
                            }

                            <AddressCompleteMap OnAddressChange="OnAddressComplete" Row="false" MultipleAddress="false" AddressList="@addresDTOList" />
                  

                    </div>
                </MudItem>
                <MudItem md="4">
           
                    <div class="d-flex flex-column gap-2">
                        @if (vm.EditingRecord.EntityType == Entity.Types.Individual)
                        {
                            <MudTextField Class="pl-4 mt-7" @bind-Value="vm.EditingRecord.SSN" Style="" Variant="Variant.Outlined"
                            Label="SSN"
                                        Mask="@socialMask"
                                        Placeholder="___-__-____"
                                        Required="true"
                                        RequiredError="SSN is required"
                                        Pattern="^\d{3}-\d{2}-\d{4}$"
                                        PatternErrorMessage="Invalid SSN format" />
                        }

                        @if (vm.EditingRecord.EntityType == DominateDocsData.Enums.Entity.Types.Entity)
                        {
                            <EntityOwner OnEntityOwnerComplete="OnEntityOwnerComplete" OnEntityOwnerCanceled="OnEntityOwnerCanceled" OwnerList="@vm.EditingRecord.EntityOwners" />
                        }

                    <MudSwitch Class="pl-4 pr-4" T="bool" @bind-Value="vm.EditingRecord.IsAliasNamesUsed" Color="Color.Primary">>Alias Names(@(vm.EditingRecord.AliasNames?.Count ?? 0))</MudSwitch>

                        @if (vm.EditingRecord.IsAliasNamesUsed)
                        {
                            <AkaAlias OnAliasComplete="OnAliasComplete" OnAliasCanceled="OnAliasCanceled" AliasList="@vm.EditingRecord.AliasNames" />
                        }

                    <MudSwitch Class="pl-4 pr-4" T="bool" @bind-Value="vm.EditingRecord.IsSignatureAuthority" Color="Color.Primary">>Signature Authority Names(@(vm.EditingRecord.SigningAuthorities?.Count ?? 0))</MudSwitch>

                        @if (vm.EditingRecord.IsSignatureAuthority)
                        {
                            <SignatureAuthority OnSigningAuthorityComplete="OnSigningAuthorityComplete" OnSigningAuthorityCanceled="OnSigningAuthorityCanceled" SigningAuthorityList="@vm.EditingRecord.SigningAuthorities" />
                        }

                        <MudStack Row="true" Spacing="5" Class="mt-5">
                            <MudSwitch Class="pl-4" T="bool" @bind-Value="vm.EditingRecord.IsLanuageTranslatorRequired" Color="Color.Primary" Label="Requires Translator" />
                            <MudSwitch Class="pl-4" T="bool" @bind-Value="vm.EditingRecord.IsAForgeinNational" Color="Color.Primary" Label="Forgein National" />
                        </MudStack>

                        @if (vm.SelectedRecord != null)
                        {
                            <MudGrid Justify="Justify.Center" AlignItems="AlignItems.Center" Class="mt-2 mb-10">
                                <MudItem md="2">
                                    <MudButton Class="" Type="Submit" OnClick="HandleSubmit" Color="Color.Success" Variant="Variant.Filled"> @(vm.SelectedRecord == null ? "Add" : "Save")</MudButton>
                                </MudItem>
                                <MudItem md="2">
                                    <MudButton Class="" OnClick="ClearSelection" Color="Color.Secondary" Variant="Variant.Filled">Clear</MudButton>
                                </MudItem>
                            </MudGrid>

                        }
                        else
                        {
                            <MudGrid Justify="Justify.Center" AlignItems="AlignItems.Center" Class="mt-2 mb-10">
                                <MudItem md="3">
                                <MudButton Class="" Type="Submit" OnClick="HandleSubmit" Color="Color.Success" Variant="Variant.Filled"> @(!editRecord ? "Add" : "Save")</MudButton>
                                </MudItem>
                                <MudItem md="3">
                                    <MudButton Class="" OnClick="ClearSelection" Color="Color.Secondary" Variant="Variant.Filled">Clear</MudButton>
                                </MudItem>
                            </MudGrid>
                        }
               
                    </div>
                
                </MudItem>
                <MudItem md="4">
                    <div class="d-flex flex-column gap-2">
          
           
                

                
                    </div>
                </MudItem>
            </MudGrid>
        </MudForm>
    
}


@code
{
    [Parameter] public EventCallback<DominateDocsData.Models.Guarantor> OnGuarantorComplete { get; set; }
    [Parameter] public EventCallback OnGuarantorCancel { get; set; }
    [Parameter] public bool AllowRecordEdit { get; set; } = false;
    [Parameter] public DominateDocsData.Models.Guarantor SelectedGuarantor { get; set; } = null;

    private bool AddEdit = false;

    private bool editRecord = false;

    private List<AddressDTO> addresDTOList = new();

    private MudForm formEditRecord;

    private readonly PatternMask phoneMask = new("(000)000-0000");
    private readonly PatternMask socialMask = new("000-00-0000");

    private MudTable<DominateDocsData.Models.Guarantor> searchTable = new();

    private List<DominateDocsData.Models.Guarantor> searchList = new();

    private string searchString = "";

    private string emailPattern = @"^[\w\-\.]+@([\w\-]+\.)+[\w\-]{2,4}$";

    private string EditPageColor = "#E9E4D7;";

    private bool AddButtonDisabled = false;

    protected override async Task OnInitializedAsync()
    {

        vm.InitializePageCommand.Execute(SelectedGuarantor);

        if (SelectedGuarantor is not null)
        {
            editRecord = true;
        }

        if (!String.IsNullOrEmpty(vm.EditingRecord.FullAddress))
        {
            AddressDTO dto = new()
            {
                FullAddress = vm.EditingRecord.FullAddress,
                StreetAddress = vm.EditingRecord.StreetAddress,
                City = vm.EditingRecord.City,
                State = vm.EditingRecord.State,
                ZipCode = vm.EditingRecord.ZipCode,
                County = vm.EditingRecord.County,
                Country = vm.EditingRecord.Country,
                Lat = vm.EditingRecord.Lat,
                Lng = vm.EditingRecord.Lng
            };
            addresDTOList.Add(dto);
        }

    }

    private IEnumerable<DominateDocsData.Models.Guarantor> FilteredList =>
       string.IsNullOrWhiteSpace(searchString)
           ? vm.RecordList
           : vm.RecordList.Where(l =>
                  (!string.IsNullOrEmpty(l.EntityName) &&
                   l.EntityName.Contains(searchString, StringComparison.OrdinalIgnoreCase))
               || (!string.IsNullOrEmpty(l.FullAddress) &&
                   l.FullAddress.Contains(searchString, StringComparison.OrdinalIgnoreCase))
               || (!string.IsNullOrEmpty(l.ContactPhoneNumber) &&
                   l.ContactPhoneNumber.Contains(searchString, StringComparison.OrdinalIgnoreCase))
               || (!string.IsNullOrEmpty(l.ContactEmail) &&
                   l.ContactEmail.Contains(searchString, StringComparison.OrdinalIgnoreCase)));

    private async Task HandleSubmit()
    {
        await formEditRecord.Validate();

        if (!formEditRecord.IsValid)
        {
            Snackbar.Add("Please correct the errors in the form.", Severity.Error);
            return;
        }
        else
        {
            if (!editRecord)
            {

                if (vm.RecordList.Any(x => (x.SSN == vm.EditingRecord.SSN && vm.EditingRecord.SSN != null) || (x.EIN == vm.EditingRecord.EIN && vm.EditingRecord.EIN != null)))
                {

                    Snackbar.Add("A Guarantor already exists choose from the list of Guarantors.", Severity.Error);
                    return;
                }
            }

            vm.UpsertRecordCommand.Execute(null);

            await OnGuarantorComplete.InvokeAsync(vm.EditingRecord);

            AddButtonDisabled = false;

            editRecord = false;

            vm.GetNewRecordCommand.Execute(null);

            StateHasChanged();
        }
    }

    private async Task SearchBackAsync()
    {
        searchString = "";

    }
                
    private void ClearSelection()
    {
        vm.ClearSelectionCommand.Execute(null);
       
        vm.EditingRecord = new DominateDocsData.Models.Guarantor();
        StateHasChanged();
    }

    private async Task AddGuarantorForEditAsync(DominateDocsData.Models.Guarantor r)
    {
        if (AllowRecordEdit)
        {
            vm.EditingRecord = r;

            editRecord = true;

            searchString = "";

            AddButtonDisabled = false;
        }
        


        StateHasChanged();
    }

    private void AddButton()
    {
        vm.EditingRecord = new DominateDocsData.Models.Guarantor();
        vm.EditingRecord.Id = Guid.NewGuid();
        vm.EditingRecord.UserId = Session.UserId;

        AddEdit = true;
        AddButtonDisabled = true;



    }

    private void OnSelectedRecord(DominateDocsData.Models.Guarantor guarantor)
    {
        searchString = "";

        vm.SelectRecordCommand.Execute(guarantor);

        editRecord = true;

        AddEdit = true;
    }

    private void OnAddressComplete(List<AddressDTO> addressList)
    {
        if (addressList == null || addressList.Count == 0)
        {
            vm.EditingRecord.FullAddress = string.Empty;
            vm.EditingRecord.StreetAddress = string.Empty;
            vm.EditingRecord.City = string.Empty;
            vm.EditingRecord.State = string.Empty;
            vm.EditingRecord.ZipCode = string.Empty;
            vm.EditingRecord.County = string.Empty;
            vm.EditingRecord.Country = string.Empty;
        }
        else
        {
            var addressDTO = addressList.FirstOrDefault();

            vm.EditingRecord.FullAddress = addressDTO.FullAddress;
            vm.EditingRecord.StreetAddress = addressDTO.StreetAddress;
            vm.EditingRecord.City = addressDTO.City;
            vm.EditingRecord.State = addressDTO.State;  
            vm.EditingRecord.ZipCode = addressDTO.ZipCode;
            vm.EditingRecord.County = addressDTO.County;
            vm.EditingRecord.Country = addressDTO.Country;
            vm.EditingRecord.Lat = addressDTO.Lat;
            vm.EditingRecord.Lng = addressDTO.Lng;
        }

    }

    private void OnEntityOwnerComplete(List<DominateDocsData.Models.EntityOwner> entityOwners)
    {
        vm.EditingRecord.EntityOwners = entityOwners;
    }

    private void OnEntityOwnerCanceled()
    {
        StateHasChanged();
    }

    private void OnSigningAuthorityComplete(List<DominateDocsData.Models.SigningAuthority> signers)
    {
        vm.EditingRecord.SigningAuthorities = signers;
    }

    private void OnSigningAuthorityCanceled()
    {
        StateHasChanged();
    }

    private void OnAliasComplete(List<DominateDocsData.Models.AkaName> alias)
    {
        vm.EditingRecord.AliasNames = alias;
    }

    private void OnAliasCanceled()
    {
        StateHasChanged();
    }

   
}