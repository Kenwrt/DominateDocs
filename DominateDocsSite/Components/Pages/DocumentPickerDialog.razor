@using MudBlazor
@using DominateDocsData.Models

<MudDialog>
    <DialogContent>

        <MudText Typo="Typo.h6" Class="mb-2">@Title</MudText>

        <!-- Select/Deselect All -->
        <MudCheckBox T="bool"
                     Label="Select all documents"
                     Value="@IsAllSelected"
                     ValueChanged="@( (bool v) => OnSelectAllChanged(v) )"
                     Indeterminate="@IsIndeterminate"
                     Class="mb-2" />



        <MudTextField @bind-Value="_search"
                      Placeholder="Search..."
                      Variant="Variant.Outlined"
                      Dense="true"
                      Immediate="true"
                      Class="mb-3"
                      Adornment="Adornment.Start"
                      AdornmentIcon="@Icons.Material.Filled.Search" />

        <MudPaper Outlined="true" Class="pa-2" Style="max-height:420px; overflow:auto;">
            @foreach (var doc in FilteredDocs)
            {
                <div @key="doc.Id">
                    <MudCheckBox T="bool"
                                 Dense="true"
                                 Label="@doc.Name"
                                 Value="@_selectedIds.Contains(doc.Id)"
                                 ValueChanged="@( (bool v) => Toggle(doc.Id, v) )" />
                </div>
            }
        </MudPaper>

    </DialogContent>

    <DialogActions>
        <MudButton Variant="Variant.Text" OnClick="Cancel">Cancel</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="Apply">Apply</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] public IMudDialogInstance MudDialog { get; set; } = default!;

    [Parameter] public string Title { get; set; } = "Select Documents";
    [Parameter] public List<DominateDocsData.Models.DTOs.DocumentListDTO> AllDocuments { get; set; } = new();
    [Parameter] public HashSet<Guid> SelectedIds { get; set; } = new();

    private HashSet<Guid> _selectedIds = new();
    private string _search = "";

    protected override void OnParametersSet()
    {
        AllDocuments ??= new();
        SelectedIds ??= new();

        _selectedIds = new HashSet<Guid>(SelectedIds);

        // prune ids that don’t exist anymore
        var valid = AllDocuments.Select(d => d.Id).ToHashSet();
        _selectedIds.RemoveWhere(id => !valid.Contains(id));
    }

    private IEnumerable<DominateDocsData.Models.DTOs.DocumentListDTO> FilteredDocs =>
        string.IsNullOrWhiteSpace(_search)
            ? AllDocuments
            : AllDocuments.Where(d => (d.Name ?? "")
                .Contains(_search, StringComparison.OrdinalIgnoreCase));

    

    private bool IsAllSelected => AllDocuments is { Count: > 0 } && AllDocuments.All(d => _selectedIds.Contains(d.Id));

    private bool IsIndeterminate => _selectedIds.Count > 0 && !IsAllSelected;

    private Task OnSelectAllChanged(bool value)
    {
        if (value)
        {
            _selectedIds.Clear();
            foreach (var d in AllDocuments)
                _selectedIds.Add(d.Id);
        }
        else
        {
            _selectedIds.Clear();
        }

        StateHasChanged();
        return Task.CompletedTask;
    }

    private void Toggle(System.Guid id, bool isChecked)
    {
        if (isChecked) _selectedIds.Add(id);
        else _selectedIds.Remove(id);

        StateHasChanged();
    }

    private void Cancel() => MudDialog.Cancel();

    private void Apply() => MudDialog.Close(DialogResult.Ok(_selectedIds));
}
