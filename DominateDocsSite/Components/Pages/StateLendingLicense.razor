@page "/statelendinglicense"

@using System.Text;
@using DominateDocsData.Models;
@using System.Globalization;
@using System.Collections.ObjectModel;
@using DominateDocsData.Models.MergeDTOs;

@rendermode InteractiveServer
@inject StateLendingLicenseViewModel vm
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar

@if (displayList)
{
    <MudTable Class="ml-4 mr-5 mb-2" Items="vm.MyRecordList" Hover="true" Style="background-color: var(--mud-palette-background);" Bordered="true" Dense="true" @bind-SelectedItem="vm.SelectedRecord" RowClick="OnSelectedRecord">
                  
                    <HeaderContent>
                        <MudTh>State</MudTh>
                        <MudTh>Lic. Number</MudTh>
                        <MudTh HeaderCellClass="text-right">
                            <MudButton Class="rounded-4"
                                       Variant="Variant.Text"
                                       Size="Size.Small"
                                       Color="Color.Primary"
                                       StartIcon="@Icons.Material.Filled.Add"
                                       OnClick="AddButton">
                                Add License
                            </MudButton>
                        </MudTh>

                    </HeaderContent>

                    <RowTemplate>
                        <MudTd DataLabel="Name">@context.State</MudTd>
                        <MudTd DataLabel="Alias">@context.LicenseNumber</MudTd>

                        <MudTd>
                <MudButton Variant="Variant.Text"
                           Size="Size.Small"
                           Color="Color.Info"
                           StartIcon="@Icons.Material.Filled.Edit"
                           OnClick="@(() => OnSelectedRecord(context))">
                    Edit
                </MudButton>

                <MudButton Variant="Variant.Text"
                           Size="Size.Small"
                           Color="Color.Error"
                           StartIcon="@Icons.Material.Filled.Delete"
                           OnClick="@(() => DeleteRecordAsync(context))">
                    Delete
                </MudButton>
            </MudTd>
                        
                    </RowTemplate>
                  

                </MudTable>

        

}
else
{
      

                <MudForm Context="contextAlias" Model="@vm.EditingRecord" @ref="@form">

                    <MudGrid>

                        <MudItem md="4">

                            <div class="d-flex flex-column gap-2">


                                <MudSelect Class="ml-4" T="DominateDocsData.Enums.UsStates.UsState" Style="" Variant="Variant.Outlined" Label="Select State" @bind-Value="vm.EditingRecord.State" Dense="true">

                                    @foreach (var tr in Enum.GetValues<DominateDocsData.Enums.UsStates.UsState>())
                                    {
                                        <MudSelectItem Style="" T="DominateDocsData.Enums.UsStates.UsState" Value="tr">@tr.GetDescription()</MudSelectItem>
                                    }

                                </MudSelect>
                                <MudTextField Class="pl-4" Style="" Variant="Variant.Outlined" @bind-Value="vm.EditingRecord.LicenseNumber" Label="License Number" Required="false" />

                                <MudStack Row="true" Spacing="10" Class="mt-4 mb-10">
                                    <MudButton Class="ml-10" Type="Submit" OnClick="HandleSubmit" Color="Color.Success" Variant="Variant.Filled">@(!editRecord ? "Add" : "Save")</MudButton>
                                    <MudButton OnClick="ClearSelection" Color="Color.Secondary" Variant="Variant.Filled">Clear</MudButton>
                                </MudStack>

                            </div>

                        </MudItem>

                    </MudGrid>

                </MudForm>

           
}




@code
{

    [Parameter] public EventCallback<List<DominateDocsData.Models.StateLendingLicense>> OnStateLicenseComplete { get; set; }
    [Parameter] public EventCallback OnStateLicenseCanceled { get; set; }
    [Parameter] public List<DominateDocsData.Models.StateLendingLicense> StateLicenseList { get; set; }

    private MudForm form;

    private bool editRecord = false;
    private bool displayList = false;
    private bool AddButtonDisabled = false;

    private int editingIndex = -1;

    protected override async Task OnInitializedAsync()
    {

        vm.InitializeLoadPageCommand.Execute(StateLicenseList);

        displayList = true;
    }

    private async Task HandleSubmit()
    {
        if (!editRecord)
        {

            if (vm.MyRecordList.Any(x => x.LicenseNumber == vm.EditingRecord.LicenseNumber))
            {
                Snackbar.Add("A Duplicate Name can't exists.", Severity.Error);

                return;
            }
        }

        vm.UpsertRecordCommand.Execute(null);

        await OnStateLicenseComplete.InvokeAsync(vm.MyRecordList.ToList());
                        
        displayList = true;

        editRecord = false;

        StateHasChanged();

        AddButtonDisabled = false;

        vm.GetNewRecordCommand.Execute(null);
        
    }

    private async Task DeleteRecordAsync(DominateDocsData.Models.StateLendingLicense r)
    {

        vm.DeleteRecordCommand.Execute(r);  
        
        vm.ClearSelectionCommand.Execute(null);

        displayList = true;

        editRecord = false;

        await OnStateLicenseComplete.InvokeAsync(vm.MyRecordList.ToList());

        StateHasChanged();
    }

    private void ClearSelection()
    {
        vm.ClearSelectionCommand.Execute(null);
        StateHasChanged();
    }

    private void AddButton()
    {
        vm.GetNewRecordCommand.Execute(null);
     
        AddButtonDisabled = false;

        displayList = false;
    }

   
    private void OnSelectedRecord(DominateDocsData.Models.StateLendingLicense r)
    {

        if (r is not null) vm.SelectRecordCommand.Execute(r);

        editRecord = true;

        displayList = false;

    }
        
    private void CancelEdit()
    {
        editingIndex = -1;

        StateHasChanged();
    }

}