@using System.Text
@using DominateDocsData.Models
@using DominateDocsData.Enums
@using System.Globalization

@rendermode InteractiveServer
@inject QuickPropertyViewModel vm
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject UserSession Session


@if (AddEdit)
{
    <MudGrid>

        <MudItem md="12">

            <MudStack Spacing="2" Class="mb-4">

                @foreach (var item in vm.MyList)
                {
                    <MudPaper Elevation="0" Class="pa-3" Style="background: #fafafa; border: 1px solid #e0e0e0; border-radius: 6px;">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                                <MudChip T="string" Size="Size.Small" Color="Color.Secondary" Variant="Variant.Filled">@item.FullAddress</MudChip>
                               
                            </MudStack>
                            <MudStack Row="true" Spacing="4">
                                <MudLink Href="#" Typo="Typo.body2" Color="Color.Primary">edit</MudLink>
                                <MudLink Href="#" Typo="Typo.body2" Color="Color.Error">remove</MudLink>
                            </MudStack>
                        </MudStack>
                    </MudPaper>
                }

            </MudStack>


            <MudButton Variant="Variant.Text"
                        Size="Size.Small"
                        Color="Color.Error"
                        StartIcon="@Icons.Material.Filled.Add"
                        OnClick="AddButton">
                Add Peoperty?
            </MudButton>

        </MudItem>

    </MudGrid>
}
else
{
    <MudItem xs="12" md="12">
        <MudPaper Elevation="1" Class="mt-5" Style="background-color: #F2F2F2;">

            <br />

            <MudText Class="pl-4 mt-5" Typo="Typo.h5">Property</MudText>

            <Property OnPropertyComplete="OnPropertyComplete" OnPropertyCancel="OnPropertyCancel" />

        </MudPaper>

    </MudItem>
}


@code
{

    [Parameter] public EventCallback<List<DominateDocsData.Models.PropertyRecord>> OnPropertyComplete { get; set; }
    [Parameter] public EventCallback OnPropertyCanceled { get; set; }
    [Parameter] public List<DominateDocsData.Models.PropertyRecord> SelectedProperties { get; set; } = new();

    private bool AddEdit = false;



    private bool AddButtonDisabled = false;

    private string searchString = "";

    // Filtered view of the Property based on searchString
    private IEnumerable<DominateDocsData.Models.PropertyRecord> FilteredList =>
        string.IsNullOrWhiteSpace(searchString) ? vm.RecordList : vm.RecordList.Where(l => string.IsNullOrEmpty(l.FullAddress) && l.FullAddress.Contains(searchString, StringComparison.OrdinalIgnoreCase)
    );


    protected override async Task OnInitializedAsync()
    {
        vm.InitializePageCommand.Execute(SelectedProperties);
    }

    

    private void OnSelectedRecord(DominateDocsData.Models.PropertyRecord r)
    {
        if (r is not null) vm.SelectRecordCommand.Execute(r);

        AddEdit = true;
    }

    private void AddButton()
    {
        vm.GetNewRecordCommand.Execute(null);

        //addresDTOList.Clear();

        AddButtonDisabled = true;

        //editRecord = false;

        //displayList = false;
    }

    private void AddExistingButton(DominateDocsData.Models.PropertyRecord r)
    {

        vm.SelectRecordCommand.Execute(r);

        int index = vm.MyList.FindIndex(x => x.Id == r.Id);

        if (index == -1) vm.MyList.Add(r);

        AddButtonDisabled = true;

        searchString = "";

       // editRecord = true;

//displayList = false;

        StateHasChanged();
    }

    private void OnDeleteRecord(DominateDocsData.Models.PropertyRecord r)
    {
        if (r is not null) vm.DeleteRecordCommand.Execute(r);

        AddEdit = false;
    }

   
    private void OnPropertyCancel()
    {

        AddEdit = false;

        StateHasChanged();
    }
}