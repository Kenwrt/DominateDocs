@using System.Text
@using DominateDocsData.Models
@using System.Globalization
@using System.Collections.ObjectModel
@using DominateDocsData.Models.MergeDTOs
@using DominateDocsSite.Helpers

@rendermode InteractiveServer
@inject QuickPropertyViewModel vm
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject PropertyRecordValidator PropertyRecordValidator
@inject UserSession Session

@if (!String.IsNullOrEmpty(searchString))
{
    <MudGrid>
        <MudItem md="12">
            <MudStack Spacing="2" Class="mb-4 mt-5">
                @foreach (var item in vm.RecordList)
                {
                    <MudPaper Elevation="0" Class="pa-3" Style="background: #fafafa; border: 1px solid #e0e0e0; border-radius: 6px;">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                                
                                <MudChip T="string" Size="Size.Small" Color="Color.Secondary" Variant="Variant.Filled">@item.FullAddress</MudChip>
                              
                            </MudStack>
                            <MudStack Row="true" Spacing="4">
                                <MudButton Variant="Variant.Text"
                                           Size="Size.Small"
                                           Color="Color.Info"
                                           StartIcon="@Icons.Material.Filled.Add"
                                           OnClick="@(() => AddExistingButton(item))">
                                    Add This Property
                                </MudButton>
                                @*  <MudLink Href="#" Typo="Typo.body2" Color="Color.Primary">edit</MudLink>
                                    <MudLink Href="#" Typo="Typo.body2" Color="Color.Error">remove</MudLink> *@
                            </MudStack>
                        </MudStack>
                    </MudPaper>
                }
            </MudStack>
        </MudItem>
    </MudGrid>
}
else
{
    @if (displayList)
    {
        <MudGrid>

            <MudItem md="12">

                <MudStack Spacing="2" Class="mb-4">

                    @foreach (var item in vm.MyList)
                    {
                        <MudPaper Elevation="0" Class="pa-3" Style="background: #fafafa; border: 1px solid #e0e0e0; border-radius: 6px;">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                                    
                                    <MudChip T="string" Size="Size.Small" Color="Color.Secondary" Variant="Variant.Filled">@item.FullAddress</MudChip>
                                   
                                </MudStack>
                                <MudStack Row="true" Spacing="4">
                                    <MudButton Variant="Variant.Text"
                                               Size="Size.Small"
                                               Color="Color.Info"
                                               StartIcon="@Icons.Material.Filled.Edit"
                                               OnClick="@(() => OnSelectedRecord(item))">
                                        Edit
                                    </MudButton>

                                    <MudButton Variant="Variant.Text"
                                               Size="Size.Small"
                                               Color="Color.Error"
                                               StartIcon="@Icons.Material.Filled.Delete"
                                               OnClick="@(() => DeleteRecordAsync(item))">
                                        Remove
                                    </MudButton>

                                </MudStack>
                            </MudStack>
                        </MudPaper>
                    }

                </MudStack>


                <MudButton Variant="Variant.Text"
                           Size="Size.Small"
                           Color="Color.Error"
                           StartIcon="@Icons.Material.Filled.Add"
                           OnClick="AddButton">
                    Add Property?
                </MudButton>

            </MudItem>

        </MudGrid>
    }
    else
    {
        <MudGrid>

            <MudItem md="12">

                <MudTextField @bind-Value="searchString"
                              Placeholder="Search..."
                              Immediate="true" />

                <MudForm Context="contextProperty" Model="@vm.EditingRecord" @ref="@formEditRecord" Validation="@PropertyRecordValidator" ValidationDelay="0">
                    <MudGrid GutterSize="3">

                        <MudItem md="4">
                            <div class="d-flex flex-column gap-2">
                                <MudSelect Class="ml-4 mt-10" Style="" T="DominateDocsData.Enums.Property.Types" Variant="Variant.Outlined" Label="Select Property Type" @bind-Value="vm.EditingRecord.PropertyType" Dense="true">

                                    @foreach (var tr in Enum.GetValues<DominateDocsData.Enums.Property.Types>())
                                    {
                                        <MudSelectItem Style="" T="DominateDocsData.Enums.Property.Types" Value="tr">@tr.GetDescription()</MudSelectItem>
                                    }

                                </MudSelect>

                                <MudSwitch Class="pl-4 mb-4 mt-4" T="bool" @bind-Value="vm.EditingRecord.IsOwnerOccupied" Color="Color.Primary" Label="Is Owner Occupied" />
                                <MudTextField Class="pl-4" Style="" Variant="Variant.Outlined" @bind-Value="vm.EditingRecord.LegalDescription" Label="Description" Required="true" />


                                <AddressCompleteMap OnAddressChange="OnAddressComplete" Row="false" MultipleAddress="false" AddressList="@addresDTOList" DisplayMap="true" />



                            </div>
                        </MudItem>
                        <MudItem md="4">
                            <div class="d-flex flex-column gap-2">

                                <MudTextField Class="pl-4 mt-10 mr-5" Style="" Variant="Variant.Outlined" @bind-Value="vm.EditingRecord.ParcelNumber" Label="Parcel Number" Required="false" />

                                <MudNumericField Class="pl-4 mr-5" Style="" HideSpinButtons="true" Adornment="Adornment.Start" AdornmentText="$" Culture="CultureInfo.InvariantCulture"
                                                 Format="N2" @bind-Value="vm.EditingRecord.EstimatedValue" Label="Estimated Value" Variant="Variant.Outlined" Step=".2M" />

                                <MudDatePicker Class="pl-4 mr-5" Style="" Label="Maturity Date" Editable="true" @bind-Date="vm.EditingRecord.LastAppraisalDate" Mask="@(new DateMask("00-00-0000"))" DateFormat="MM-dd-yyyy" Placeholder="mm-dd-yyyy" Variant="Variant.Outlined" />

                                <MudNumericField Class="pl-4 mr-5" Style="" HideSpinButtons="true" Adornment="Adornment.Start" AdornmentText="$" Culture="CultureInfo.InvariantCulture"
                                                 Format="N2" @bind-Value="vm.EditingRecord.MinimumReleasePrice" Label="Minumum Release Price" Variant="Variant.Outlined" Step=".2M" />


                                <MudNumericField Class="pl-4 mr-5" Style="" HideSpinButtons="true" Culture="CultureInfo.InvariantCulture"
                                                 Format="N0" @bind-Value="vm.EditingRecord.SquareFootage" Label="Square Footage" Variant="Variant.Outlined" />

                            </div>
                        </MudItem>
                        <MudItem md="4">
                            <div class="d-flex flex-column gap-2">

                                <MudSwitch Class="pl-4 pr-4 mt-8" T="bool" @bind-Value="vm.EditingRecord.IsPropertyOwnerDisplay" Color="Color.Primary">Property Owners(@(vm.EditingRecord?.PropertyOwners?.Count ?? 0))</MudSwitch>

                                @if (vm.EditingRecord.IsPropertyOwnerDisplay)
                                {
                                    <PropertyOwner OnPropertyOwnerComplete="OnPropertyOwnerComplete" OnPropertyOwnerCancel="OnPropertyOwnerCancel" AllowRecordEdit=true PropertyOwnerList="vm.EditingRecord.PropertyOwners" />
                                }


                                <MudStack Row="true" Spacing="2" Class="ml-20 mb-15">
                                    <MudButton Class="pl-4 mr-15" Type="Submit" OnClick="HandleSubmit" Color="Color.Success" Variant="Variant.Filled"> @(!editRecord ? "Add" : "Save")</MudButton>
                                    <MudButton Class="pl-4" OnClick="ClearSelection" Color="Color.Secondary" Variant="Variant.Filled">Clear</MudButton>
                                </MudStack>
                            </div>
                        </MudItem>

                    </MudGrid>
                </MudForm>

            </MudItem>

        </MudGrid>
    }

}



@code
{
    [Parameter] public EventCallback<List<DominateDocsData.Models.PropertyRecord>> OnPropertyComplete { get; set; }
    [Parameter] public EventCallback OnPropertyCanceled { get; set; }
    [Parameter] public List<DominateDocsData.Models.PropertyRecord> SelectedProperties { get; set; } = new();

    public MudTable<DominateDocsData.Models.PropertyRecord> listTable = null;

    private MudTable<DominateDocsData.Models.PropertyRecord> searchTable = new();

    private int index = 0;

    private MudForm formEditRecord;

    private bool editRecord = false;

    private bool displayList = false;

    private bool AddButtonDisabled = false;

    private List<DominateDocsData.Models.Lender> searchList = new();

    private List<AddressDTO> addresDTOList = new();

    private readonly PatternMask phoneMask = new("(000)000-0000");

    private readonly PatternMask einMask = new("00-0000000");

    private readonly PatternMask socialMask = new("000-00-0000");

    private string emailPattern = @"^[\w\-\.]+@([\w\-]+\.)+[\w\-]{2,4}$";

    private string ssnMask = "000-00-0000";

    private int editingIndex = -1;

    private string searchString = "";

    // Filtered view of the borrower based on searchString
    private IEnumerable<DominateDocsData.Models.PropertyRecord> FilteredList =>
        string.IsNullOrWhiteSpace(searchString)
            ? vm.RecordList
            : vm.RecordList.Where(l => !string.IsNullOrEmpty(l.FullAddress) && l.FullAddress.Contains(searchString, StringComparison.OrdinalIgnoreCase));

    protected override async Task OnInitializedAsync()
    {
        vm.InitializePageCommand.Execute(SelectedProperties);

        if (!String.IsNullOrEmpty(vm.EditingRecord.FullAddress))
        {
            AddressDTO dto = new()
            {
                FullAddress = vm.EditingRecord.FullAddress,
                StreetAddress = vm.EditingRecord.StreetAddress,
                City = vm.EditingRecord.City,
                ZipCode = vm.EditingRecord.ZipCode,
                County = vm.EditingRecord.County,
                Country = vm.EditingRecord.Country,
                State = vm.EditingRecord.State,
                Lat = vm.EditingRecord.Lat,
                Lng = vm.EditingRecord.Lng
            };

            addresDTOList.Add(dto);
        }


        displayList = true;
    }

    private async Task HandleSubmit()
    {
        await formEditRecord.Validate();

        if (!formEditRecord.IsValid)
        {
            Snackbar.Add("Please correct the errors in the form.", Severity.Error);
            return;
        }
        else
        {
            if (editRecord == false)
            {
                if (vm.RecordList.Any(x => (x.FullAddress == vm.EditingRecord.FullAddress)))
                {

                    Snackbar.Add("A Property already exists choose from the list of Properties.", Severity.Error);
                    return;
                }
            }

            vm.UpsertRecordCommand.Execute(null);

            await OnPropertyComplete.InvokeAsync(vm.MyList.ToList());

            editRecord = false;

            displayList = true;

            AddButtonDisabled = false;

            StateHasChanged();
        }
    }

    private void OnAddressComplete(List<AddressDTO> addressList)
    {
        if (addressList == null || addressList.Count == 0)
        {
            vm.EditingRecord.FullAddress = string.Empty;
            vm.EditingRecord.StreetAddress = string.Empty;
            vm.EditingRecord.City = string.Empty;
            vm.EditingRecord.ZipCode = string.Empty;
            vm.EditingRecord.County = string.Empty;
            vm.EditingRecord.Country = string.Empty;
        }
        else
        {
            var addressDTO = addressList.FirstOrDefault();

            vm.EditingRecord.FullAddress = addressDTO.FullAddress;
            vm.EditingRecord.StreetAddress = addressDTO.StreetAddress;
            vm.EditingRecord.City = addressDTO.City;
            vm.EditingRecord.ZipCode = addressDTO.ZipCode;
            vm.EditingRecord.County = addressDTO.County;
            vm.EditingRecord.Country = addressDTO.Country;
            vm.EditingRecord.State = addressDTO.State;
            vm.EditingRecord.Lat = addressDTO.Lat;
            vm.EditingRecord.Lng = addressDTO.Lng;
        }

    }

    private async Task SearchBackAsync()
    {
        searchString = "";

    }

    private async Task DeleteRecordAsync(DominateDocsData.Models.PropertyRecord r)
    {
        vm.SelectedRecord = r;

        vm.DeleteRecordCommand.Execute(r);

        await OnPropertyComplete.InvokeAsync(vm.MyList.ToList());

        displayList = true;

        StateHasChanged();



    }

    private void ClearSelection()
    {
        vm.ClearSelectionCommand.Execute(null);
        StateHasChanged();
    }

    private void AddFromSearchForEditAsync(DominateDocsData.Models.PropertyRecord r)
    {
        vm.EditingRecord = r;

        AddressDTO address = new()
        {
            FullAddress = r.FullAddress,
            Lat = r.Lat,
            Lng = r.Lng,
            StreetAddress = r.StreetAddress,
            City = r.City,
            State = r.State,
            ZipCode = r.ZipCode,
            County = r.County,
            Country = r.Country
        };

        addresDTOList.Add(address);

        searchString = "";

        AddButtonDisabled = true;
        StateHasChanged();
    }

    private void AddButton()
    {
        vm.GetNewRecordCommand.Execute(null);

        addresDTOList.Clear();

        AddButtonDisabled = true;

        editRecord = false;

        displayList = false;
    }

    private void AddExistingButton(DominateDocsData.Models.PropertyRecord r)
    {

        vm.SelectRecordCommand.Execute(r);

        int index = vm.MyList.FindIndex(x => x.Id == r.Id);

        if (index == -1) vm.MyList.Add(r);

        AddButtonDisabled = true;

        searchString = "";

        editRecord = true;

        displayList = false;

        StateHasChanged();
    }

    private void OnSelectedRecord(DominateDocsData.Models.PropertyRecord r)
    {
        if (r is not null) vm.SelectRecordCommand.Execute(r);

        if (!String.IsNullOrEmpty(vm.EditingRecord.FullAddress))
        {
            addresDTOList.Clear();

            AddressDTO dto = new()
            {
                FullAddress = vm.EditingRecord.FullAddress,
                StreetAddress = vm.EditingRecord.StreetAddress,
                City = vm.EditingRecord.City,
                ZipCode = vm.EditingRecord.ZipCode,
                County = vm.EditingRecord.County,
                Country = vm.EditingRecord.Country,
                State = vm.EditingRecord.State,
                Lat = vm.EditingRecord.Lat,
                Lng = vm.EditingRecord.Lng
            };

            addresDTOList.Add(dto);
        }

        displayList = false;
        editRecord = true;
    }

    private async Task EditRecordAsync(DominateDocsData.Models.PropertyRecord r)
    {
        OnSelectedRecord(r);

        displayList = false;

        StateHasChanged();

    }

    private void CancelEdit()
    {
        editingIndex = -1;

        StateHasChanged();
    }

    private void OnPropertyOwnerComplete(List<DominateDocsData.Models.PropertyOwner> propertyOwnerList)
    {
        vm.EditingRecord.PropertyOwners = propertyOwnerList;

        vm.UpsertRecordCommand.Execute(null);
    }

    private void OnPropertyOwnerCancel()
    {
        // No action needed for now
    }

}