@page "/quickloanagreementnewlook"
@using MudBlazor

@using System.Globalization

@inject NavigationManager Nav
@inject QuickLoanAgreementViewModel vm
@inject QuickLoanAgreementValidator loanValidator
@inject UserSession Session

<style>
    .wizard-stepper .mud-stepper-actions {
        display: none !important;
    }

    /* Keeps the stepper looking like your centered three-step header */
    .wizard-stepper {
        width: 520px;
        max-width: 90vw;
    }

    /* Optional: tighten the stepper spacing a bit */
    .wizard-stepper .mud-stepper-horizontal {
        justify-content: center;
    }

</style>

<MudContainer MaxWidth="MaxWidth.Large" Class="py-10">

    <!-- HEADER -->
    <div class="d-flex flex-column align-center text-center">
        <MudText Typo="Typo.h6">Create Loan Documents</MudText>
        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-2">
            Three quick steps to generate your documents
        </MudText>

        <!-- REAL STEPPER (CENTERED) -->
        <MudStepper Class="mt-6 wizard-stepper"
                    Linear="true"
                    AlternativeLabel="true"
                    @bind-ActiveIndex="ActiveStep"
                    Elevation="0" 
                    ShowPreviousButton="false"
                    ShowNextButton="false">

            <MudStep Text="Loan Type" />
            <MudStep Text="Loan Info." />
            <MudStep Text="Loan Details" />
            

            <ActionsContent>
                @* Intentionally empty: kills the top Previous/Next bar *@
            </ActionsContent>

        </MudStepper>
    </div>

    <!-- MAIN CARD -->
    @* <MudPaper Elevation="0" Class="mx-auto mt-10" Style="max-width: 920px; border-radius: 16px; border: 1px solid var(--mud-palette-lines-default); overflow: hidden;"> *@
    <MudPaper Elevation="0" Class="mx-auto mt-10" Style="max-width: 1380px; border-radius: 16px; border: 1px solid var(--mud-palette-lines-default); overflow: hidden;">

        @* STEP 1 *@
        @if (ActiveStep == 0)
        {
            <div class="pa-7">
                

                <MudTextField Class="" Style="background-color: white;" Variant="Variant.Outlined" @bind-Value="vm.EditingAgreement.ReferenceName" For="@(() => vm.EditingAgreement.ReferenceName)" Label="Give your Project a name!" Required="true" />


                <MudGrid Class="mt-6" GutterSize="3">

                    <MudItem xs="12">
                        <MudText Typo="Typo.h6">What type of loan is this?</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-1"> Select the loan type to load the right document package. </MudText>
                    </MudItem>

                    @foreach (var type in vm.LoanTypes)
                    {
                        <MudItem xs="12" sm="6" md="4">
                            <MudPaper Elevation="0" Class="rounded-lg" Style="@GetTileStyle(SelectedLoanType == type.Name)" 
                                @onclick="@(() =>
                                {                                            
                                    SelectedLoanType = type.Name;
                                    vm.EditingAgreement.LoanTypeId = type.Id;
                                    
                                })">
                                <div class="d-flex flex-column align-center justify-center"
                                        style="height: 120px; padding: 18px;">
                                    <MudAvatar Variant="Variant.Outlined"
                                                Size="Size.Large"
                                                Color="Color.Default"
                                                Class="mb-3">
                                        <MudIcon Icon="@ResolveIcon(type.IconKey)" />
                                    </MudAvatar>

                                    <MudText Typo="Typo.subtitle2">@type.Name</MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-1">
                                        @type.Description
                                    </MudText>
                                </div>
                            </MudPaper>
                        </MudItem>
                    }

                </MudGrid>
            </div>

            <div class="px-7 py-5 d-flex align-center justify-end"
                 style="border-top: 1px solid var(--mud-palette-lines-default); background: rgba(0,0,0,0.01);">

                <MudButton Variant="Variant.Filled"
                           Color="Color.Dark"
                           Disabled="@(!CanGoNext)"
                           EndIcon="@Icons.Material.Filled.ArrowForward"
                           OnClick="NextFromLoanType"
                           Class="rounded-lg"
                           Style="min-width: 120px;">
                    Next
                </MudButton>
            </div>
        }

        @* STEP 2 *@
        else if (ActiveStep == 1)
        {
            <div class="pa-7">
                <MudText Typo="Typo.h6">Loan Info - Add general loan information </MudText>
                
                <MudGrid Spacing="3">

                   @*  <MudItem xs="12">
                        <MudText Typo="Typo.h6">Loan Info - Add general loan information</MudText>
                        
                    </MudItem> *@

                    <MudItem xs="12" sm="6">
                        <div class="d-flex flex-column gap-2">

                            <MudNumericField Class="" Style="background-color: white;" HideSpinButtons="true" Adornment="Adornment.Start" AdornmentText="$" Culture="CultureInfo.InvariantCulture"
                                             Format="N2" @bind-Value="vm.EditingAgreement.PrincipalAmount" Label="Principal Amount" Variant="Variant.Outlined" Step=".2M" />

                            <MudSelect Variant="Variant.Outlined" T="Payment.RateTypes" @bind-Value="vm.EditingAgreement.RateType" Label="Interest Rate Type">
                                @foreach (var v in Enum.GetValues<Payment.RateTypes>())
                                {
                                    <MudSelectItem Value="v">@v</MudSelectItem>
                                }
                            </MudSelect>


                            <MudNumericField Immediate="false" Class="" Variant="Variant.Outlined" HideSpinButtons="true" T="decimal" @bind-Value="vm.EditingAgreement.InterestRate" Format="N2" Label="Interest Rate (%)" />

                            <MudSelect Class="" Variant="Variant.Outlined" T="Payment.AmortizationTypes" @bind-Value="vm.EditingAgreement.AmorizationType" Label="Payment Type">
                                @foreach (var v in Enum.GetValues<Payment.AmortizationTypes>())
                                {
                                    <MudSelectItem Value="v">@v</MudSelectItem>
                                }
                            </MudSelect>

                            <MudNumericField Immediate="false" Class="" Variant="Variant.Outlined" T="int" HideSpinButtons="true" @bind-Value="vm.EditingAgreement.TermInMonths" Label="Term (months)" />

                        </div>

                    </MudItem>

                    <MudItem xs="12" sm="6">

                        <div class="d-flex flex-column gap-2">
                            @if (vm.EditingAgreement.RateType == Payment.RateTypes.Variable)
                            {
                                <MudNumericField Immediate="false" Class="" Variant="Variant.Outlined" HideSpinButtons="true" T="decimal" @bind-Value="vm.EditingAgreement.InitialMargin" Format="N2" Label="Initial Margin (%)" />
                            }
                            <MudSelect Class="" Variant="Variant.Outlined" T="Payment.Schedules" @bind-Value="vm.EditingAgreement.RepaymentSchedule" Label="Repayment Schedule">
                                @foreach (var v in Enum.GetValues<Payment.Schedules>())
                                {
                                    <MudSelectItem Value="v">@v</MudSelectItem>
                                }
                            </MudSelect>

                            @if (vm.EditingAgreement.RateType == Payment.RateTypes.Variable)
                            {

                                <MudSelect Class="" Variant="Variant.Outlined" T="Payment.Schedules" @bind-Value="vm.EditingAgreement.VariableInterestProperties.AdjustmentInterval" Label="Adjustment Intervals">
                                    @foreach (var v in Enum.GetValues<Payment.Schedules>())
                                    {
                                        <MudSelectItem Value="v">@v</MudSelectItem>
                                    }
                                </MudSelect>

                                <MudSelect Class="" Variant="Variant.Outlined" T="Payment.IndexPaths" @bind-Value="vm.EditingAgreement.VariableInterestProperties.AssumedIndexPath" Label="Assumed Index Path">
                                    @foreach (var v in Enum.GetValues<Payment.IndexPaths>())
                                    {
                                        <MudSelectItem Value="v">@v</MudSelectItem>
                                    }
                                </MudSelect>
                            }

                            <MudDatePicker Variant="Variant.Outlined" @bind-Date="vm.EditingAgreement.OriginationDate" Label="Origination Date" />

                        </div>

                    </MudItem>

                </MudGrid>




            </div>

            <div class="px-7 py-5 d-flex align-center justify-space-between"
                 style="border-top: 1px solid var(--mud-palette-lines-default); background: rgba(0,0,0,0.01);">
                <MudButton Variant="Variant.Outlined"
                           Color="Color.Dark"
                           StartIcon="@Icons.Material.Filled.ArrowBack"
                           OnClick="Back">
                    Back
                </MudButton>

                <MudButton Variant="Variant.Filled"
                           Color="Color.Dark"
                           EndIcon="@Icons.Material.Filled.ArrowForward"
                           OnClick="Next">
                    Next
                </MudButton>
            </div>
        }

        @* STEP 3 *@
        else
        {
            <div class="pa-7">


                <MudItem xs="12">
                    <MudText Typo="Typo.h6">Enter Loan Details</MudText>
                    
                </MudItem>

                <MudPaper Elevation="0" Class="rounded-xl pa-6" Style="background-color: #ffffff; border: 1px solid rgba(0,0,0,0.08);">
                   
                    <MudGrid GutterSize="3" Justify="Justify.Center">
                        @foreach (var defaultFormSelection in Enum.GetValues<DominateDocsData.Enums.QuickLoanSettings.FormSections>())
                        {
                            <MudItem xs="12" sm="4" md="4">
                                <div class="w-100"
                                     style="@($"cursor:pointer; {GetTileStyle(SelectedDefaultFormTypeUi == defaultFormSelection)}")"
                                     @onclick="@(() => SelectedDefualtForm(defaultFormSelection))">
                                    <div class="d-flex flex-column align-center justify-center"
                                         style="height: 96px; border-radius: 12px;">
                                        <MudIcon Icon="@(GetFormIcon(defaultFormSelection))" Size="Size.Large" Class="mb-2" />
                                        <MudText Typo="Typo.subtitle2">@defaultFormSelection.ToString()</MudText>
                                    </div>
                                </div>
                            </MudItem>
                        }
                    </MudGrid>


                    <MudGrid Class="mt-6" GutterSize="3">
                        <MudItem xs="12" sm="12" md="12">

                            @if (SelectedDefaultFormTypeUi == DominateDocsData.Enums.QuickLoanSettings.FormSections.Lender)
                            {
                                <QuickLoanLender OnLenderComplete="OnLenderComplete" OnLenderCanceled="OnLenderCanceled" SelectedLenders="@vm.EditingAgreement.Lenders" />
                            }
                            else if (SelectedDefaultFormTypeUi == DominateDocsData.Enums.QuickLoanSettings.FormSections.Broker)
                            {
                                <QuickLoanBroker OnBrokerComplete="OnBrokerComplete" OnBrokerCanceled="OnBrokerCanceled" SelectedBrokers="@vm.EditingAgreement.Brokers" />
                            }
                            else if (SelectedDefaultFormTypeUi == DominateDocsData.Enums.QuickLoanSettings.FormSections.Borrower)
                            {
                                <QuickLoanBorrower OnBorrowerComplete="OnBorrowerComplete" OnBorrowerCanceled="OnBorrowerCanceled" SelectedBorrowers="@vm.EditingAgreement.Borrowers" />
                            }
                            else if (SelectedDefaultFormTypeUi == DominateDocsData.Enums.QuickLoanSettings.FormSections.Guarantor)
                            {
                                <QuickLoanGuarantor OnGuarantorComplete="OnGuarantorComplete" OnGuarantorCanceled="OnGuarantorCanceled" SelectedGuarantors="@vm.EditingAgreement.Guarantors" />
                            }
                            else if (SelectedDefaultFormTypeUi == DominateDocsData.Enums.QuickLoanSettings.FormSections.Property )
                            {
                                <QuickLoanProperty OnPropertyComplete="OnPropertyComplete" OnPropertyCanceled="OnPropertyCanceled" SelectedProperties="@vm.EditingAgreement.Properties" />                                                
                            }
                            else if (SelectedDefaultFormTypeUi == DominateDocsData.Enums.QuickLoanSettings.FormSections.Servicer)
                            {

                                <QuickLoanServicer OnServicerComplete="OnServicerComplete" OnServicerCanceled="OnServicerCanceled" SelectedServicers="@vm.EditingAgreement.Servicers" />
                            }

                        </MudItem>
                    </MudGrid>

                   
                </MudPaper>
            </div>

            <div class="px-7 py-5 d-flex align-center justify-space-between"
                 style="border-top: 1px solid var(--mud-palette-lines-default); background: rgba(0,0,0,0.01);">
                <MudButton Variant="Variant.Outlined"
                           Color="Color.Dark"
                           StartIcon="@Icons.Material.Filled.ArrowBack"
                           OnClick="Back">
                    Back
                </MudButton>

                <MudButton Variant="Variant.Filled"
                           Color="Color.Dark"
                           EndIcon="@Icons.Material.Filled.PlayArrow"
                           OnClick="Generate">
                    Generate
                </MudButton>
            </div>
        }
    </MudPaper>
</MudContainer>



@code 
{

    private int ActiveStep { get; set; } = 0;

    private string? SelectedLoanType { get; set; }


    // Applied once after the VM loads (existing agreement / defaults)
    private bool loanTypeDefaultApplied;

    private bool defaultProfileApplied = false;

    private DominateDocsData.Enums.QuickLoanSettings.FormSections? SelectedDefaultFormTypeUi { get; set; } = null;


    private bool CanGoNext => !string.IsNullOrWhiteSpace(SelectedLoanType);

    private DominateDocsData.Enums.UserEnums.UserTypes? SelectedRoleUi { get; set; } = null;

    private IReadOnlyList<(DominateDocsData.Enums.UserEnums.UserTypes Value, string Label, string Icon)> Roles { get; } =
       Enum.GetValues<DominateDocsData.Enums.UserEnums.UserTypes>()
           .Select(v => (Value: v, Label: v.GetDescription(), Icon: GetRoleIcon(v)))
           .ToList();

    private readonly List<(string Value, string Label, string Description, string Icon)> LoanTypes = new()
    {
        ("ConstructionRehab", "Construction / Rehab", "Draw-based funding",            Icons.Material.Filled.Inventory2),
        ("BridgeFixFlip",     "Bridge / Fix & Flip",  "Short-term acquisition",        Icons.Material.Filled.HomeWork),
        ("DSCRRental",        "DSCR / Rental",        "Long-term investment",          Icons.Material.Filled.CreditCard),
        ("Commercial",        "Commercial",           "Office, retail, industrial",    Icons.Material.Filled.Apartment),
        ("Multifamily",       "Multifamily",          "5+ unit residential",           Icons.Material.Filled.Group),
        ("LandLot",           "Land / Lot",           "Raw land financing",            Icons.Material.Filled.Layers),
    };

    private static string GetTileStyle(bool selected)
        => selected
            ? "cursor:pointer; border: 1px solid rgba(20, 50, 255, 0.35); background: rgba(20, 50, 255, 0.04); border-radius: 14px;"
            : "cursor:pointer; border: 1px solid var(--mud-palette-lines-default); background: var(--mud-palette-surface); border-radius: 14px;";

    protected override async Task OnInitializedAsync()
    {
        vm.InitializePageCommand.Execute(null);

        SelectedRoleUi = UserEnums.UserTypes.Lender;

          
        if (vm.EditingAgreement.UserType == UserEnums.UserTypes.Lender)
        {
            SelectedDefaultFormTypeUi = DominateDocsData.Enums.QuickLoanSettings.FormSections.Lender;

        }
        else if (vm.EditingAgreement.UserType == UserEnums.UserTypes.Broker)
        {
            SelectedDefaultFormTypeUi = DominateDocsData.Enums.QuickLoanSettings.FormSections.Broker;
        }
        else if (vm.EditingAgreement.UserType == UserEnums.UserTypes.Servicer)
        {
            SelectedDefaultFormTypeUi = DominateDocsData.Enums.QuickLoanSettings.FormSections.Servicer;
        }

       
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // Run after render so we don't have to change how InitializePageCommand executes.
        // This ensures vm.LoanTypes + vm.EditingAgreement are populated before we attempt defaults.
        if (loanTypeDefaultApplied)
            return;

        if (vm?.EditingAgreement is null || vm.LoanTypes is null || vm.LoanTypes.Count == 0)
            return;

        // Only default Step 1 when we already have a stored loan type on the agreement
        if (vm.EditingAgreement.LoanTypeId == System.Guid.Empty && string.IsNullOrWhiteSpace(vm.EditingAgreement.LoanTypeName))
            return;

        ApplyLoanTypeDefaultsFromAgreement();
        loanTypeDefaultApplied = true;

        await InvokeAsync(StateHasChanged);
    }

    private void ApplyLoanTypeDefaultsFromAgreement()
    {
        if (vm?.EditingAgreement is null || vm.LoanTypes is null || vm.LoanTypes.Count == 0)
            return;

        var id = vm.EditingAgreement.LoanTypeId;
        var name = vm.EditingAgreement.LoanTypeName;

        // Prefer ID match (most reliable)
        var match = vm.LoanTypes.FirstOrDefault(x => x.Id == id);

        // Fallback to Name match
        if (match is null && !string.IsNullOrWhiteSpace(name))
            match = vm.LoanTypes.FirstOrDefault(x => string.Equals(x.Name, name, System.StringComparison.OrdinalIgnoreCase));

        if (match is null)
            return;

        // Drives Step 1 tile highlight + Next button enable
        SelectedLoanType = match.Name;

        // Keep agreement values consistent
        vm.EditingAgreement.LoanTypeId = match.Id;
        vm.EditingAgreement.LoanTypeName = match.Name;
    }


    private void SelectRole(DominateDocsData.Enums.UserEnums.UserTypes role)
    {

        // Enable Continue without auto-advancing
        SelectedRoleUi = role;

        StateHasChanged();
    }

    private void SelectedDefualtForm(DominateDocsData.Enums.QuickLoanSettings.FormSections formSection)
    {

        // Enable Continue without auto-advancing
        SelectedDefaultFormTypeUi = formSection;

        StateHasChanged();
    }


    private static string GetRoleIcon(DominateDocsData.Enums.UserEnums.UserTypes role) => role switch
    {
        DominateDocsData.Enums.UserEnums.UserTypes.Lender => Icons.Material.Filled.AccountBalance,
        DominateDocsData.Enums.UserEnums.UserTypes.Broker => Icons.Material.Filled.Handshake,
        DominateDocsData.Enums.UserEnums.UserTypes.Servicer => Icons.Material.Filled.VerifiedUser,
        _ => Icons.Material.Filled.HelpOutline
    };

    private static string GetFormIcon(DominateDocsData.Enums.QuickLoanSettings.FormSections formSelection) => formSelection switch
    {
        DominateDocsData.Enums.QuickLoanSettings.FormSections.Lender => Icons.Material.Filled.AccountBalance,
        DominateDocsData.Enums.QuickLoanSettings.FormSections.Broker => Icons.Material.Filled.Handshake,
        DominateDocsData.Enums.QuickLoanSettings.FormSections.Guarantor => Icons.Material.Filled.Shield,
        DominateDocsData.Enums.QuickLoanSettings.FormSections.Property => Icons.Material.Filled.Home,
        DominateDocsData.Enums.QuickLoanSettings.FormSections.Servicer => Icons.Material.Filled.VerifiedUser,
        _ => Icons.Material.Filled.HelpOutline
    };

    private void NextFromLoanType()
    {
        if (!CanGoNext) return;
        ActiveStep = 1;
    }

    private void Next()
    {
        if (ActiveStep < 2)
            ActiveStep++;
    }

    private void Back()
    {
        if (ActiveStep > 0)
            ActiveStep--;
    }

    private static string ResolveIcon(string? key) => key switch
    {
        "Inventory2" => Icons.Material.Filled.Inventory2,
        "HomeWork" => Icons.Material.Filled.HomeWork,
        "CreditCard" => Icons.Material.Filled.CreditCard,
        "Apartment" => Icons.Material.Filled.Apartment,
        "Group" => Icons.Material.Filled.Group,
        "Layers" => Icons.Material.Filled.Layers,
        _ => Icons.Material.Filled.HelpOutline
    };

    private void Generate()
    {
        // Hook this to your actual doc generation pipeline.
        // e.g. vm.GenerateDocumentsCommand.Execute(null);
    }

   

    private void OnPropertyAddressComplete(List<AddressDTO> list)
    {
        if (vm.EditingAgreement.Properties is not null)
        {
            vm.EditingAgreement.Properties.Clear();
        }

        foreach (var p in list)
        {
            PropertyRecord propertyRecord = new()
            {
                FullAddress = p.FullAddress,
                StreetAddress = p.StreetAddress,
                City = p.City,
                ZipCode = p.ZipCode,
                County = p.County,
                Country = p.Country,
                Lat = p.Lat,
                Lng = p.Lng
            };

            if (!vm.EditingAgreement.Properties.Any(x => x.FullAddress != p.FullAddress))
            {
                vm.EditingAgreement.Properties.Add(propertyRecord);
            }
        }

        vm.UpsertRecordCommand.Execute(null);
    }
       

    private void OnBrokerComplete(List<DominateDocsData.Models.Broker> list)
    {

        vm.EditingAgreement.Brokers.Clear();
        vm.EditingAgreement.Brokers = list;
        vm.UpsertRecordCommand.Execute(null);
    }

    private void OnPropertyComplete(List<DominateDocsData.Models.PropertyRecord> list)
    {

        vm.EditingAgreement.Properties.Clear();
        vm.EditingAgreement.Properties = list;
        vm.UpsertRecordCommand.Execute(null);
    }

    
    

    private void OnServicerComplete(List<DominateDocsData.Models.Servicer> list)
    {
        // vm.EditingAgreement.Servicers.Clear();
        // vm.EditingAgreement.Servicers = list;
        vm.UpsertRecordCommand.Execute(null);
       
    }

   

    private void OnBorrowerComplete(List<DominateDocsData.Models.Borrower> list)
    {
        vm.EditingAgreement.Borrowers.Clear();

        vm.EditingAgreement.Borrowers = list;

        vm.UpsertRecordCommand.Execute(null);
    }

    private void OnLenderComplete(List<DominateDocsData.Models.Lender> list)
    {
        vm.EditingAgreement.Lenders.Clear();
        vm.EditingAgreement.Lenders = list;
        vm.UpsertRecordCommand.Execute(null);

    }

    private void OnGuarantorComplete(List<DominateDocsData.Models.Guarantor> list)
    {
        vm.EditingAgreement.Guarantors.Clear();
        vm.EditingAgreement.Guarantors = list;
        vm.UpsertRecordCommand.Execute(null);

    }


    private void OnBorrowerCanceled()
    {

    }


    private void OnGuarantorCanceled()
    {

    }

   
    private void OnPropertyCanceled()
    {

    }

    private void OnBrokerCanceled()
    {

    }

    private void OnLenderCanceled()
    {

    }

    private void OnServicerCanceled()
    {

    }

    
}
