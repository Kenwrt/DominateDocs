@page "/guarantorlist"

@using System.Text
@using DominateDocsData.Models
@using DominateDocsData.Enums
@using System.Globalization

@rendermode InteractiveServer
@inject GuarantorViewModel viewModel
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject UserSession Session


 <MudGrid Class="mb-10">

@if (!AddEdit)
{
     <MudItem xs="12" md="12">
            <MudTable Items="FilteredList"
                      Hover="true"
                      Bordered="true"
                      Dense="true"
                      @bind-SelectedItem="viewModel.SelectedRecord"
                      RowClick="OnSelectedRecord">
                <ToolBarContent>
                    <MudTextField @bind-Value="searchString"
                                  Placeholder="Search..."
                                  Immediate="true" />
                </ToolBarContent>
                <HeaderContent>
                    <MudTh>Entity Name</MudTh>
                    <MudTh>Address</MudTh>
                    <MudTh>Phone</MudTh>
                    <MudTh>Email</MudTh>
                    <MudTh>Active</MudTh>
                    <MudTh>
                        <MudButton Class="rounded-4"
                                   Disabled="@AddButtonDisabled"
                                   Variant="Variant.Text"
                                   Size="Size.Small"
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.Add"
                                   OnClick="AddButton">
                            Add Guarantor
                        </MudButton>

                       
                    </MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Enitity Name">@context.EntityName</MudTd>
                    <MudTd DataLabel="Address">@context.FullAddress</MudTd>
                    <MudTd DataLabel="Phone">@context.ContactPhoneNumber</MudTd>
                    <MudTd DataLabel="Email">@context.ContactEmail</MudTd>
                    <MudTd DataLabel="Active">
                        <MudChip T="bool" Color="@((context.IsActive) ? Color.Success : Color.Error)">
                            @(context.IsActive ? "Yes" : "No")
                        </MudChip>
                    </MudTd>
                    <MudTd>
                        <MudButton Variant="Variant.Text"
                                   Size="Size.Small"
                                   Color="Color.Info"
                                   StartIcon="@Icons.Material.Filled.Edit"
                                   OnClick="@(() => OnSelectedRecord(context))">
                            Edit
                        </MudButton>

                        <MudButton Variant="Variant.Text"
                                   Size="Size.Small"
                                   Color="Color.Error"
                                   StartIcon="@Icons.Material.Filled.Delete"
                                   OnClick="@(() => OnDeleteRecord(context))">
                            Delete
                        </MudButton>
                    </MudTd>
                </RowTemplate>
                <NoRecordsContent>
                    <MudText Color="Color.Secondary" Class="pa-4">
                        🚫 No Active Guarantors Found. Please add!
                    </MudText>
                </NoRecordsContent>
            </MudTable>
    </MudItem>
}
else
{
        <MudItem xs="12" md="12">
            <MudPaper Elevation="1" Class="mt-5" Style="background-color: #F2F2F2;">
                
                <br />

                <MudText Class="pl-4 mt-5" Typo="Typo.h5">Guarantor</MudText>


                <Guarantor OnGuarantorComplete="OnGuarantorComplete" OnGuarantorCancel="OnGuarantorCancel" AllowRecordEdit="true" SelectedGuarantor="@viewModel.SelectedRecord" />

            </MudPaper>

        </MudItem>
}      
</MudGrid>





@code
{
    private bool AddEdit = false;
    
    private string searchString = "";
    
    private bool AddButtonDisabled = false;

    

    protected override async Task OnInitializedAsync()
    {

        viewModel.InitializePageCommand.Execute(null);

        
    }

   

    // Filtered view of the guarantors based on searchString
    private IEnumerable<DominateDocsData.Models.Guarantor> FilteredList =>
        string.IsNullOrWhiteSpace(searchString)
            ? viewModel.RecordList
            : viewModel.RecordList.Where(l =>
                   (!string.IsNullOrEmpty(l.EntityName) &&
                    l.EntityName.Contains(searchString, StringComparison.OrdinalIgnoreCase))
                || (!string.IsNullOrEmpty(l.FullAddress) &&
                    l.FullAddress.Contains(searchString, StringComparison.OrdinalIgnoreCase))
                || (!string.IsNullOrEmpty(l.ContactPhoneNumber) &&
                    l.ContactPhoneNumber.Contains(searchString, StringComparison.OrdinalIgnoreCase))
                || (!string.IsNullOrEmpty(l.ContactEmail) &&
                    l.ContactEmail.Contains(searchString, StringComparison.OrdinalIgnoreCase)));

    private void AddButton()
    {
        viewModel.GetNewRecordCommand.Execute(null);
       
        AddEdit = true;
        AddButtonDisabled = true;


    }

    private void OnSelectedRecord(DominateDocsData.Models.Guarantor guarantor)
    {
        if (guarantor is not null) viewModel.SelectRecordCommand.Execute(guarantor);

        AddEdit = true;
    }

    private void OnDeleteRecord(DominateDocsData.Models.Guarantor r)
    {
        if (r is not null) viewModel.DeleteRecordCommand.Execute(r);

        AddEdit = false;
    }

    private void OnGuarantorComplete()
    {
        AddEdit = false;

        StateHasChanged();
    }

    private void OnGuarantorCancel()
    {

        AddEdit = false;

        StateHasChanged();
    }
}