@page "/propertylist"

@using System.Text
@using DominateDocsData.Models
@using DominateDocsData.Enums
@using System.Globalization

@rendermode InteractiveServer
@inject PropertyViewModel vm
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject UserSession Session

<MudGrid Class="mb-10">

    @if (!AddEdit)
    {
        
            <MudItem xs="12" md="12">
            <MudTable Context="context" Items="FilteredList" Hover="true" Bordered="true" Dense="true" @bind-SelectedItem="vm.SelectedRecord" RowClick="OnSelectedRecord">
                    <ToolBarContent>
                        <MudTextField @bind-Value="searchString" Placeholder="Search..." />
                    </ToolBarContent>
                    <HeaderContent>
                        <MudTh>Address</MudTh>
                        <MudTh>Est. Value</MudTh>
                        <MudTh>Last Appraisal</MudTh>
                        <MudTh>Last Appraisal Value</MudTh>
                        <MudTh></MudTh>
                        <MudTh>
                           <MudButton Class="rounded-4"
                                   Disabled="@AddButtonDisabled"
                                   Variant="Variant.Text"
                                   Size="Size.Small"
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.Add"
                                   OnClick="AddButton">
                            Add Property
                            </MudButton>
                        </MudTh>
                    </HeaderContent>
                    <RowTemplate>
                    <MudTd DataLabel="Address">@context.FullAddress</MudTd>
                    <MudTd DataLabel="Est. Value">@context.EstimatedValue</MudTd>
                    <MudTd DataLabel="Last Appraisal"> @context.LastAppraisalDate </MudTd>
                    <MudTd DataLabel="Last Appraisal Value">@context.LastAppraisedValue </MudTd>
                        <MudTd DataLabel="Active">
                        <MudChip T="bool" Color="@((context.IsActive) ? Color.Success : Color.Error)">
                            @(context.IsActive ? "Yes" : "No")
                            </MudChip>
                        </MudTd>
                        <MudTd>
                        <MudButton Variant="Variant.Text"
                                   Size="Size.Small"
                                   Color="Color.Info"
                                   StartIcon="@Icons.Material.Filled.Edit"
                                   OnClick="@(() => OnSelectedRecord(context))">
                            Edit
                        </MudButton>

                        <MudButton Variant="Variant.Text"
                                   Size="Size.Small"
                                   Color="Color.Error"
                                   StartIcon="@Icons.Material.Filled.Delete"
                                   OnClick="@(() => OnDeleteRecord(context))">
                            Delete
                        </MudButton>
                    </MudTd>
                    </RowTemplate>
                <NoRecordsContent>
                    <MudText Color="Color.Secondary" Class="pa-4">
                        🚫 No Active Properties Found. Please add!
                    </MudText>
                </NoRecordsContent>
                </MudTable>
            </MudItem>
        
    }
    else
    {
        <MudItem xs="12" md="12">
            <MudPaper Elevation="1" Class="mt-5" Style="background-color: #F2F2F2;">

                <br />

                <MudText Class="pl-4 mt-5" Typo="Typo.h5">Property</MudText>

                <Property OnPropertyComplete="OnPropertyComplete" OnPropertyCancel="OnPropertyCancel" AllowRecordEdit="true" />

            </MudPaper>

        </MudItem>
    }
</MudGrid>





@code
{
    private bool AddEdit = false;



    private bool AddButtonDisabled = false;

    private string searchString = "";

    // Filtered view of the Property based on searchString
    private IEnumerable<DominateDocsData.Models.PropertyRecord> FilteredList =>
        string.IsNullOrWhiteSpace(searchString) ? vm.RecordList : vm.RecordList.Where(l => string.IsNullOrEmpty(l.FullAddress) && l.FullAddress.Contains(searchString, StringComparison.OrdinalIgnoreCase)
    );


    protected override async Task OnInitializedAsync()
    {
        vm.InitializePageCommand.Execute(null);
    }

    private void AddButton()
    {
        vm.GetNewRecordCommand.Execute(null);   

        AddEdit = true;

        AddButtonDisabled = true;


    }

    private void OnSelectedRecord(DominateDocsData.Models.PropertyRecord r)
    {
        if (r is not null) vm.SelectRecordCommand.Execute(r);

        AddEdit = true;
    }

    private void OnDeleteRecord(DominateDocsData.Models.PropertyRecord r)
    {
        if (r is not null) vm.DeleteRecordCommand.Execute(r);

        AddEdit = false;
    }

    private void OnPropertyComplete()
    {
        AddEdit = false;

        StateHasChanged();
    }

    private void OnPropertyCancel()
    {

        AddEdit = false;

        StateHasChanged();
    }
}