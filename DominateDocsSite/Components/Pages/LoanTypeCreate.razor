@using DominateDocsData.Models
@using DominateDocsData.Models.DTOs
@using DominateDocsData.Models.RulesEngine
@using MudBlazor
@using System.Reflection

@inject LoanTypeViewModel vm
@inject IDialogService DialogService
@inject NavigationManager Nav

<style>
    /* Loan Type Create page polish */
    .loan-type-create .mud-breadcrumbs {
        margin-bottom: 12px;
    }

    /* Make the breadcrumb items feel clickable and consistent */
    .loan-type-create .mud-breadcrumb-item a {
        text-decoration: none;
    }

        .loan-type-create .mud-breadcrumb-item a:hover {
            text-decoration: underline;
        }

    /* Align the details section fields nicely */
    .loan-type-create .loan-type-details .mud-input-control {
        margin-bottom: 0;
    }

    /* Manual breadcrumbs (always renders) */
    .loan-type-create .loan-breadcrumbs {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: .95rem;
        margin-bottom: 12px;
    }

        .loan-type-create .loan-breadcrumbs .crumb-sep {
            opacity: .6;
        }

    /* Icon preview line */
    .loan-type-create .icon-preview {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 8px;
    }

    /* Default document chips spacing */
    .loan-type-create .default-docs {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }

        .loan-type-create .default-docs .mud-chip {
            margin: 0;
        }

    .loan-type-create .crumb-link {
        color: #1976d2 !important; /* blue */
        font-weight: 600;
    }

        .loan-type-create .crumb-link:hover {
            color: #2e7d32 !important; /* green on hover */
            text-decoration: underline;
            cursor: pointer;
        }
</style>

<MudContainer MaxWidth="MaxWidth.False" Class="pa-4 loan-type-create">

    <!-- BREADCRUMBS (manual so it actually shows) -->
    <div class="loan-breadcrumbs">
        <MudButton Variant="Variant.Text"
                   Color="Color.Primary"
                   Class="crumb-btn"
                   OnClick="@GoToLoanTypeList">
            Loan Types
        </MudButton>

        <span class="crumb-sep">/</span>

        <MudText Inline="true" Typo="Typo.body2" Color="Color.Secondary">
            @((SelectedLoanType is null) ? "Add Loan Type" : "Edit Loan Type")
        </MudText>
    </div>


    <MudText Typo="Typo.h6">Loan Type</MudText>

    <MudText Typo="Typo.body2" Class="mb-3 mud-text-secondary">
        Define the loan type basics (name, description, icon), then configure rules.
    </MudText>

    <!-- Loan Type Details -->
    <MudPaper Elevation="0" Outlined="true" Class="pa-3 mb-3 loan-type-details">
        <MudText Typo="Typo.subtitle2" Class="mb-2">Loan Type Details</MudText>

        <MudGrid GutterSize="3">
            <MudItem xs="12" md="4">
                <MudTextField T="string"
                              Label="Name"
                              Variant="Variant.Outlined"
                              Immediate="true"
                              @bind-Value="vm.EditingLoanType.Name" />
            </MudItem>

            <MudItem xs="12" md="4">
                <MudTextField T="string"
                              Label="Description"
                              Variant="Variant.Outlined"
                              Immediate="true"
                              @bind-Value="vm.EditingLoanType.Description" />
            </MudItem>

            <MudItem xs="12" md="4">
                <MudSelect T="string"
                           Label="Icon"
                           Variant="Variant.Outlined"
                           Dense="true"
                           Clearable="true"
                           @bind-Value="vm.EditingLoanType.IconKey">

                    @foreach (var opt in IconOptions)
                    {
                        <MudSelectItem Value="@opt.Key">
                            <div class="d-flex align-center" style="gap:10px;">
                                <MudIcon Icon="@opt.Icon" />
                                <MudText Typo="Typo.body2">@opt.Key</MudText>
                            </div>
                        </MudSelectItem>
                    }
                </MudSelect>

                @if (!string.IsNullOrWhiteSpace(vm.EditingLoanType.IconKey))
                {
                    <div class="icon-preview">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Preview:</MudText>
                        <MudIcon Icon="@GetIconByKey(vm.EditingLoanType.IconKey)" />
                    </div>
                }
            </MudItem>
        </MudGrid>
    </MudPaper>

    <MudDivider Class="my-3" />

    <MudText Typo="Typo.h6">Loan Type Rules</MudText>

    <MudText Typo="Typo.body2" Class="mb-3 mud-text-secondary">
        Configure which documents generate by default and which generate conditionally.
    </MudText>

    <!-- Default Documents -->
    <MudPaper Elevation="0" Outlined="true" Class="pa-3 mb-3">
        <div class="d-flex align-center justify-space-between mb-2">
            <MudText Typo="Typo.subtitle2">Default Documents</MudText>

            <div class="d-flex align-center" style="gap:10px;">
                <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="@OpenDefaultDocsPicker">
                    Select Documents
                </MudButton>

                <MudButton Variant="Variant.Text" Color="Color.Error" OnClick="@RemoveAllLogic">
                    Remove all logic
                </MudButton>
            </div>
        </div>

        <div class="default-docs">
            @foreach (var id in (vm.EditingLoanType.DefaultDocumentIds ?? new List<Guid>()))
            {
                <MudChip T="string"
                         Size="Size.Small"
                         Variant="Variant.Outlined"
                         Closeable="true"
                         OnClose="@(() => RemoveDefaultDoc(id))">
                    @GetDocNameById(id)
                </MudChip>
            }
        </div>
    </MudPaper>

    <!-- Output Rules -->
    @foreach (var rule in vm.OutputRulesUi)
    {
        <OutputRuleEditor Rule="rule"
                          MasterDocumentDTOs="vm.MasterDocumentDtos"
                          Fields="vm.Fields"
                          FieldValues="vm.FieldValues"
                          OnChanged="OnRulesChanged"
                          OnRemoveRequested="@(() => RemoveRule(rule))" />
    }

    <div class="d-flex align-center mt-3" style="gap:10px;">
        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   StartIcon="@Icons.Material.Filled.AddCircleOutline"
                   OnClick="@AddRule">
            Add output rule
        </MudButton>

        <MudSpacer />

        <MudButton Variant="Variant.Text"
                   Color="Color.Secondary"
                   OnClick="@Cancel">
            Cancel
        </MudButton>

        <MudButton Variant="Variant.Filled"
                   Color="Color.Success"
                   StartIcon="@Icons.Material.Filled.CheckCircle"
                   Disabled="@SaveDisabled"
                   OnClick="@Complete">
            Save
        </MudButton>
    </div>

</MudContainer>

@code {
    [Parameter] public EventCallback<LoanType> OnLoanTypeComplete { get; set; }
    [Parameter] public EventCallback OnLoanTypeCancel { get; set; }
    [Parameter] public LoanTypeListDTO? SelectedLoanType { get; set; }

    private static readonly IReadOnlyList<(string Key, string Icon)> IconOptions = BuildIconOptions();

    private bool SaveDisabled => string.IsNullOrWhiteSpace(vm.EditingLoanType.Name);

    protected override void OnParametersSet()
    {
        var selectedId = TryGetGuid(SelectedLoanType, "Id", "LoanTypeId", "_id");

        if (selectedId.HasValue && selectedId.Value != Guid.Empty)
            vm.LoadForEdit(selectedId.Value);
        else
            vm.LoadForCreate();

        vm.EnsureLogic();
        SyncUiToModel();
    }

    private void AddRule()
    {
        vm.AddOutputRule();
        SyncUiToModel();
    }

    private void RemoveRule(OutputRule rule)
    {
        vm.RemoveOutputRule(rule);
        SyncUiToModel();
    }

    private void RemoveAllLogic()
    {
        vm.ClearAllLogic();
        SyncUiToModel();
    }

    private void RemoveDefaultDoc(Guid id)
    {
        vm.EditingLoanType.DefaultDocumentIds ??= new List<Guid>();
        vm.EditingLoanType.DefaultDocumentIds.Remove(id);
    }

    private void AddDefaultDoc(Guid id)
    {
        if (id == Guid.Empty) return;

        vm.EditingLoanType.DefaultDocumentIds ??= new List<Guid>();
        if (!vm.EditingLoanType.DefaultDocumentIds.Contains(id))
            vm.EditingLoanType.DefaultDocumentIds.Add(id);
    }

    private void OpenDefaultDocsPicker()
    {
        vm.EditingLoanType.DefaultDocumentIds ??= new List<Guid>();
        var selected = new HashSet<Guid>(vm.EditingLoanType.DefaultDocumentIds);

        var parameters = new DialogParameters
        {
            ["Title"] = "Select Default Documents",
            ["AllDocuments"] = vm.MasterDocumentDtos,
            ["SelectedIds"] = selected,
            ["OnSelected"] = (Action<Guid>)((id) =>
            {
                AddDefaultDoc(id);
                InvokeAsync(StateHasChanged);
            })
        };

        var options = new DialogOptions { CloseButton = false, FullWidth = true, MaxWidth = MaxWidth.Medium };
        DialogService.Show<DocumentPickerDialog>("Select Documents", parameters, options);
    }

    private Task OnRulesChanged()
    {
        SyncUiToModel();
        return Task.CompletedTask;
    }

    private void SyncUiToModel()
    {
        vm.EditingLoanType.OutputRules ??= new List<OutputRule>();
        vm.EditingLoanType.OutputRules = vm.OutputRulesUi.ToList();
    }

    private async Task Complete()
    {
        if (string.IsNullOrWhiteSpace(vm.EditingLoanType.Name))
            return;

        var saved = vm.EditingLoanType;
        vm.CommitUiToModel();

        if (OnLoanTypeComplete.HasDelegate)
            await OnLoanTypeComplete.InvokeAsync(saved);
    }

    private async Task Cancel()
    {
        if (OnLoanTypeCancel.HasDelegate)
            await OnLoanTypeCancel.InvokeAsync();

        Nav.NavigateTo("/LoanTypeList");
    }

    private static Guid? TryGetGuid(object? obj, params string[] propertyNames)
    {
        if (obj is null) return null;

        var t = obj.GetType();
        foreach (var name in propertyNames)
        {
            var p = t.GetProperty(name, BindingFlags.Public | BindingFlags.Instance);
            if (p is null) continue;

            var val = p.GetValue(obj);
            if (val is Guid g) return g;
            if (val is string s && Guid.TryParse(s, out var parsed)) return parsed;
        }

        return null;
    }

    private string GetDocNameById(Guid id)
    {
        var doc = vm.MasterDocumentDtos.FirstOrDefault(x => x.Id == id);
        return doc is not null ? doc.Name : "Unknown Document";
    }

    private static IReadOnlyList<(string Key, string Icon)> BuildIconOptions()
    {
        var t = typeof(Icons.Material.Filled);

        var fields = t.GetFields(BindingFlags.Public | BindingFlags.Static)
            .Where(f => f.FieldType == typeof(string))
            .OrderBy(f => f.Name);

        var props = t.GetProperties(BindingFlags.Public | BindingFlags.Static)
            .Where(p => p.PropertyType == typeof(string))
            .OrderBy(p => p.Name);

        var list = new List<(string Key, string Icon)>();

        foreach (var f in fields)
        {
            var icon = f.GetValue(null) as string;
            if (!string.IsNullOrWhiteSpace(icon))
                list.Add((f.Name, icon));
        }

        foreach (var p in props)
        {
            var icon = p.GetValue(null) as string;
            if (!string.IsNullOrWhiteSpace(icon) && !list.Any(x => x.Key == p.Name))
                list.Add((p.Name, icon));
        }

        return list;
    }

    private string GetIconByKey(string? key)
    {
        if (string.IsNullOrWhiteSpace(key))
            return Icons.Material.Filled.HelpOutline;

        var match = IconOptions.FirstOrDefault(x => string.Equals(x.Key, key, StringComparison.OrdinalIgnoreCase));
        return string.IsNullOrWhiteSpace(match.Icon) ? Icons.Material.Filled.HelpOutline : match.Icon;
    }

    private void GoToLoanTypeList()
    {
        // Your list page is: @page "/loantypelist"
        // Force-load ensures navigation even if some UI layer is blocking SPA routing.
        Nav.NavigateTo("/loantypelist", forceLoad: true);
    }

}
