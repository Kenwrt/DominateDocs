@using DominateDocsData.Models
@using DominateDocsData.Models.DTOs
@using DominateDocsData.Models.RulesEngine
@using MudBlazor
@using System.Reflection

@inject LoanTypeViewModel vm
@inject IDialogService DialogService

<MudContainer MaxWidth="MaxWidth.False" Class="pa-4">

    <MudText Typo="Typo.h6">Loan Type Rules</MudText>

    <MudText Typo="Typo.body2" Class="mb-3 mud-text-secondary">
        Configure which documents generate by default and which generate conditionally.
    </MudText>

    <!-- Default Documents -->
    <MudPaper Elevation="0" Outlined="true" Class="pa-3 mb-3">
        <div class="d-flex align-center justify-space-between mb-2">
            <MudText Typo="Typo.subtitle2">Default Documents</MudText>

            <div class="d-flex align-center" style="gap:10px;">
                <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="@OpenDefaultDocsPicker">
                    Select Documents
                </MudButton>

                <MudButton Variant="Variant.Text" Color="Color.Error" OnClick="@RemoveAllLogic">
                    Remove all logic
                </MudButton>
            </div>
        </div>

        <div class="d-flex flex-wrap align-center" style="gap:8px;">
            @foreach (var id in (vm.EditingLoanType.DefaultDocumentIds ?? new List<Guid>()))
            {
                <MudChip T="string"
                         Size="Size.Small"
                         Variant="Variant.Outlined"
                         Closeable="true"
                         OnClose="@(() => RemoveDefaultDoc(id))">
                    @GetDocNameById(id)
                </MudChip>
            }
        </div>
    </MudPaper>

    <!-- Output Rules -->
    @foreach (var rule in vm.OutputRulesUi)
    {
        <OutputRuleEditor Rule="rule"
                          MasterDocuments="vm.MasterDocuments"
                          Fields="vm.Fields"
                          FieldValues="vm.FieldValues"
                          OnChanged="OnRulesChanged"
                          OnRemoveRequested="@(() => RemoveRule(rule))" />
    }

    <div class="d-flex align-center mt-3" style="gap:10px;">
        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   StartIcon="@Icons.Material.Filled.AddCircleOutline"
                   OnClick="@AddRule">
            Add output rule
        </MudButton>

        <MudSpacer />

        <MudButton Variant="Variant.Text"
                   Color="Color.Secondary"
                   OnClick="@Cancel">
            Cancel
        </MudButton>

        <MudButton Variant="Variant.Filled"
                   Color="Color.Success"
                   StartIcon="@Icons.Material.Filled.CheckCircle"
                   OnClick="@Complete">
            Save
        </MudButton>
    </div>

</MudContainer>

@code {
    [Parameter] public EventCallback<LoanType> OnLoanTypeComplete { get; set; }
    [Parameter] public EventCallback OnLoanTypeCancel { get; set; }
    [Parameter] public LoanTypeListDTO? SelectedLoanType { get; set; }

    protected override void OnParametersSet()
    {
        var selectedId = TryGetGuid(SelectedLoanType, "Id", "LoanTypeId", "_id");

        if (selectedId.HasValue && selectedId.Value != Guid.Empty)
            vm.LoadForEdit(selectedId.Value);
        else
            vm.LoadForCreate();

        vm.EnsureLogic();
        SyncUiToModel();
    }

    private void AddRule()
    {
        vm.AddOutputRule();
        SyncUiToModel();
    }

    private void RemoveRule(OutputRule rule)
    {
        vm.RemoveOutputRule(rule);
        SyncUiToModel();
    }

    private void RemoveAllLogic()
    {
        vm.ClearAllLogic();
        SyncUiToModel();
    }

    private void RemoveDefaultDoc(Guid id)
    {
        vm.EditingLoanType.DefaultDocumentIds ??= new List<Guid>();
        vm.EditingLoanType.DefaultDocumentIds.Remove(id);
    }

    private async Task OpenDefaultDocsPicker()
    {
        vm.EditingLoanType.DefaultDocumentIds ??= new List<Guid>();
        var selected = new HashSet<Guid>(vm.EditingLoanType.DefaultDocumentIds);

        var parameters = new DialogParameters
        {
            ["Title"] = "Select Default Documents",
            ["AllDocuments"] = vm.MasterDocuments,
            ["SelectedIds"] = selected
        };

        var options = new DialogOptions { CloseButton = true, FullWidth = true, MaxWidth = MaxWidth.Medium };

        var dialog = DialogService.Show<DocumentPickerDialog>("Select Documents", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is HashSet<Guid> picked)
            vm.EditingLoanType.DefaultDocumentIds = picked.ToList();
    }

    private Task OnRulesChanged()
    {
        SyncUiToModel();
        return Task.CompletedTask;
    }

    private void SyncUiToModel()
    {
        vm.EditingLoanType.OutputRules ??= new List<OutputRule>();
        vm.EditingLoanType.OutputRules = vm.OutputRulesUi.ToList();
    }

    private async Task Complete()
    {
        var saved = vm.EditingLoanType;
        vm.CommitUiToModel();

        if (OnLoanTypeComplete.HasDelegate)
            await OnLoanTypeComplete.InvokeAsync(saved);
    }

    private async Task Cancel()
    {
        if (OnLoanTypeCancel.HasDelegate)
            await OnLoanTypeCancel.InvokeAsync();
    }

    // -----------------------------
    // Reflection helpers
    // -----------------------------

    private static Guid? TryGetGuid(object? obj, params string[] propertyNames)
    {
        if (obj is null) return null;

        var t = obj.GetType();
        foreach (var name in propertyNames)
        {
            var p = t.GetProperty(name, BindingFlags.Public | BindingFlags.Instance);
            if (p is null) continue;

            var val = p.GetValue(obj);
            if (val is Guid g) return g;
            if (val is string s && Guid.TryParse(s, out var parsed)) return parsed;
        }

        return null;
    }

    private string GetDocNameById(Guid id)
    {
        // FIX: MasterDocuments is non-null; don't use ?? at all.
        var docs = vm.MasterDocuments;

        var doc = docs.FirstOrDefault(d => GetDocumentId(d) == id);
        if (doc is null) return id.ToString();
        return GetDocumentDisplayName(doc);
    }

    private static Guid GetDocumentId(DominateDocsData.Models.Document doc)
    {
        foreach (var name in new[] { "Id", "DocumentId", "_id" })
        {
            var prop = doc.GetType().GetProperty(name, BindingFlags.Public | BindingFlags.Instance);
            if (prop is null) continue;

            var val = prop.GetValue(doc);
            if (val is Guid g && g != Guid.Empty) return g;

            if (val is string s && Guid.TryParse(s, out var parsed) && parsed != Guid.Empty)
                return parsed;
        }

        return Guid.Empty;
    }

    private static string GetDocumentDisplayName(DominateDocsData.Models.Document doc)
    {
        foreach (var name in new[] { "Name", "Title", "DisplayName", "DocumentName", "FileName" })
        {
            var prop = doc.GetType().GetProperty(name, BindingFlags.Public | BindingFlags.Instance);
            if (prop is null) continue;

            if (prop.GetValue(doc) is string s && !string.IsNullOrWhiteSpace(s))
                return s;
        }

        var id = GetDocumentId(doc);
        return id == Guid.Empty ? "(Unnamed Document)" : id.ToString();
    }
}
