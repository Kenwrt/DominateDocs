@page "/adminbench"

@using DocumentManager.State
@using MudBlazor
@using DominateDocsSite.ViewModels
@using DominateDocsData.Enums
@using DominateDocsData.Models
@using DocumentManager.Email

@namespace DominateDocsSite.ViewModels

@inject AdminBenchViewModel vm

<MudContainer MaxWidth="MaxWidth.Large" Class="py-6">
    <MudPaper Class="pa-4" Elevation="1">

        <MudText Typo="Typo.h6">Admin Bench</MudText>

        <MudDivider Class="my-4" />

        <MudGrid GutterSize="3">

            <MudItem xs="12" md="6">
                <MudSelect T="Guid"
                           Label="Doc Library"
                           Variant="Variant.Outlined"
                           @bind-Value="vm.SelectedDocLibId"
                           @bind-Value:after="vm.OnDocLibChangedAsync">
                    @foreach (var id in vm.DocLibIds)
                    {
                        <MudSelectItem Value="id">@id</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>

            <MudItem xs="12" md="6">
                <MudSelect T="DocumentTypes.OutputTypes"
                           Label="Output Type (bench override)"
                           Variant="Variant.Outlined"
                           @bind-Value="vm.OutputType">
                    <MudSelectItem Value="DocumentTypes.OutputTypes.PDF">PDF</MudSelectItem>
                    <MudSelectItem Value="DocumentTypes.OutputTypes.DOCX">DOCX</MudSelectItem>
                </MudSelect>
            </MudItem>

            <MudItem xs="12" md="6">
                <MudSelect T="LoanAgreement"
                           Label="Loan Agreement"
                           Variant="Variant.Outlined"
                           @bind-Value="vm.SelectedLoanAgreement"
                           @bind-Value:after="vm.OnLoanAgreementChangedAsync"
                           ToStringFunc="@(l => l is null ? "" : vm.GetLoanLabel(l))">
                    @foreach (var loan in vm.LoanAgreements)
                    {
                        <MudSelectItem Value="loan">@vm.GetLoanLabel(loan)</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>

            <MudItem xs="12" md="6">
                <MudTextField Label="Email To (optional)"
                              Variant="Variant.Outlined"
                              @bind-Value="vm.EmailTo" />
            </MudItem>

            <MudItem xs="12" md="6">
                <MudSelect T="EmailEnums.AttachmentOutput"
                           Label="Email Attachment Mode"
                           Variant="Variant.Outlined"
                           @bind-Value="vm.EmailAttachmentOutput">
                    <MudSelectItem Value="EmailEnums.AttachmentOutput.IndividualDocument">Individual Documents</MudSelectItem>
                    <MudSelectItem Value="EmailEnums.AttachmentOutput.ZipFile">Single ZIP File</MudSelectItem>
                </MudSelect>
            </MudItem>

            <MudItem xs="12" md="6">
                <MudSelect T="LoanType"
                           Label="Loan Type"
                           Variant="Variant.Outlined"
                           @bind-Value="vm.SelectedLoanType"
                           @bind-Value:after="vm.OnLoanTypeChangedAsync"
                           ToStringFunc="@(lt => lt?.Name ?? "")">
                    @foreach (var lt in vm.LoanTypes)
                    {
                        <MudSelectItem Value="lt">@lt.Name</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>

            <MudItem xs="12">
                <MudDivider Class="my-2" />
                <div class="d-flex flex-wrap gap-2">
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Secondary"
                               Disabled="@(vm.IsBusy || !vm.CanRunOneButton)"
                               OnClick="vm.RunMergeAndEmailAsync">
                        Run Merge + Email
                    </MudButton>
                </div>
            </MudItem>

            @if (!string.IsNullOrWhiteSpace(vm.Status))
            {
                <MudItem xs="12">
                    <MudAlert Severity="Severity.Info" Dense="true">@vm.Status</MudAlert>
                </MudItem>
            }

            <MudItem xs="12">
                <MudDivider Class="my-4" />
                <MudText Typo="Typo.subtitle1">Persisted Deliveries</MudText>

                @if (vm.SelectedLoanAgreement is null)
                {
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Select a loan to view results.</MudText>
                }
                else if (vm.SelectedLoanDeliveries.Count == 0)
                {
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        No deliveries saved on this loan (yet). The Run button will generate them first.
                    </MudText>
                }
                else
                {
                    <MudTable Items="vm.SelectedLoanDeliveries" Dense="true" Hover="true">
                        <HeaderContent>
                            <MudTh>Document</MudTh>
                            <MudTh>DocId</MudTh>
                            <MudTh>Output</MudTh>
                            <MudTh>Type</MudTh>
                            <MudTh>Location</MudTh>
                            <MudTh>Copies</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd>@vm.GetDocName(context.DocId)</MudTd>
                            <MudTd><MudText Typo="Typo.caption">@context.DocId</MudText></MudTd>
                            <MudTd>@context.OutputType</MudTd>
                            <MudTd>@context.DelieveryTypes</MudTd>
                            <MudTd>@context.DeliveryLoaction</MudTd>
                            <MudTd>@context.Copies</MudTd>
                        </RowTemplate>
                    </MudTable>
                }
            </MudItem>

            <MudItem xs="12">
                <MudDivider Class="my-4" />
                <MudText Typo="Typo.subtitle1">Live Merge Results</MudText>

                @if (vm.LiveMergeRows.Count == 0)
                {
                    <MudText Typo="Typo.body2" Color="Color.Secondary">No merges yet.</MudText>
                }
                else
                {
                    <MudTable Items="vm.LiveMergeRows" Dense="true" Hover="true">
                        <HeaderContent>
                            <MudTh>Status</MudTh>
                            <MudTh>Document</MudTh>
                            <MudTh>Completed</MudTh>
                            <MudTh>Bytes</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd>@context.Status</MudTd>
                            <MudTd>@context.DocumentName</MudTd>
                            <MudTd>@context.CompletedLocal</MudTd>
                            <MudTd>@context.Bytes</MudTd>
                        </RowTemplate>
                    </MudTable>
                }
            </MudItem>

        </MudGrid>
    </MudPaper>
</MudContainer>

@code {
    protected override async Task OnInitializedAsync()
    {
        await vm.InitializeAsync();
    }
}
