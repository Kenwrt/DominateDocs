@page "/adminbench"

@using DocumentManager.State
@using MudBlazor
@using DominateDocsSite.ViewModels
@using DominateDocsData.Enums
@using DominateDocsData.Models

@namespace DominateDocsSite.ViewModels

@inject IDocumentManagerState DocState
@inject AdminBenchViewModel vm

<MudContainer MaxWidth="MaxWidth.Large" Class="py-6">
    <MudPaper Class="pa-4" Elevation="1">

        <MudText Typo="Typo.h6">Admin Bench: Test Merge (Workers)</MudText>
        <MudText Typo="Typo.body2" Color="Color.Secondary">
            Queues jobs to LoanWorker / MergeWorker. No direct merge calls from the UI.
            ThenGenerate runs automatically when LoanType changes.
        </MudText>

        <MudDivider Class="my-4" />

        <MudGrid GutterSize="3">

            <MudItem xs="12" md="6">
                <MudSelect T="Guid"
                           Label="Doc Library"
                           Variant="Variant.Outlined"
                           @bind-Value="vm.SelectedDocLibId"
                           @bind-Value:after="OnDocLibChanged">
                    @foreach (var id in vm.DocLibIds)
                    {
                        <MudSelectItem Value="id">@id</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>

            <MudItem xs="12" md="6">
                <MudSelect T="DocumentTypes.OutputTypes"
                           Label="Output Type"
                           Variant="Variant.Outlined"
                           @bind-Value="vm.OutputType">
                    <MudSelectItem Value="DocumentTypes.OutputTypes.PDF">PDF</MudSelectItem>
                    <MudSelectItem Value="DocumentTypes.OutputTypes.DOCX">DOCX</MudSelectItem>
                </MudSelect>
            </MudItem>

            <MudItem xs="12" md="6">
                <MudSelect T="LoanAgreement"
                           Label="Loan Agreement"
                           Variant="Variant.Outlined"
                           @bind-Value="vm.SelectedLoanAgreement"
                           @bind-Value:after="OnLoanChanged"
                           ToStringFunc="@(l => l is null ? "" : vm.GetLoanLabel(l))">
                    @foreach (var loan in vm.LoanAgreements)
                    {
                        <MudSelectItem Value="loan">@vm.GetLoanLabel(loan)</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>

            <MudItem xs="12" md="6">
                <MudTextField Label="Email To (optional)"
                              Variant="Variant.Outlined"
                              @bind-Value="vm.EmailTo" />
            </MudItem>

            <MudItem xs="12" md="12">
                <MudSelect T="LoanType"
                           Label="Loan Type"
                           Variant="Variant.Outlined"
                           @bind-Value="vm.SelectedLoanType"
                           @bind-Value:after="OnLoanTypeChanged"
                           ToStringFunc="@(lt => lt?.Name ?? "")">
                    @foreach (var lt in vm.LoanTypes)
                    {
                        <MudSelectItem Value="lt">@lt.Name</MudSelectItem>
                    }
                </MudSelect>

                <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-1">
                    Auto-queues ThenGenerate when changed.
                </MudText>
            </MudItem>

            <MudItem xs="12">
                <MudDivider Class="my-2" />
                <div class="d-flex flex-wrap gap-2">
                    <MudButton Variant="Variant.Outlined"
                               Disabled="vm.IsBusy"
                               OnClick="vm.ReloadAsync">
                        Reload Lists
                    </MudButton>

                    <MudButton Variant="Variant.Outlined"
                               Disabled="vm.IsBusy"
                               OnClick="vm.RefreshSelectedLoanAsync">
                        Refresh Results
                    </MudButton>

                    <MudButton Variant="Variant.Filled"
                               Disabled="@(vm.IsBusy || !vm.CanMergeFromDeliveries)"
                               OnClick="vm.QueueMergeFromDeliveriesAsync">
                        Queue Merge From Deliveries
                    </MudButton>

                    <MudButton Variant="Variant.Outlined"
                               Disabled="vm.IsBusy"
                               OnClick="@(() => vm.Clear())">
                        Clear
                    </MudButton>
                </div>
            </MudItem>

            @if (!string.IsNullOrWhiteSpace(vm.Status))
            {
                <MudItem xs="12">
                    <MudAlert Severity="Severity.Info" Dense="true">@vm.Status</MudAlert>
                </MudItem>
            }

            <MudItem xs="12">
                <MudDivider Class="my-4" />
                <MudText Typo="Typo.subtitle1">ThenGenerate Results (Persisted Deliveries)</MudText>

                @if (vm.SelectedLoanAgreement is null)
                {
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Select a loan to view results.</MudText>
                }
                else if (vm.SelectedLoanDeliveries.Count == 0)
                {
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        No deliveries saved on this loan yet. Change LoanType to auto-run ThenGenerate, then results will appear here.
                    </MudText>
                }
                else
                {
                    <MudTable Items="vm.SelectedLoanDeliveries" Dense="true" Hover="true">
                        <HeaderContent>
                            <MudTh>Document</MudTh>
                            <MudTh>DocId</MudTh>
                            <MudTh>Output</MudTh>
                            <MudTh>Type</MudTh>
                            <MudTh>Location</MudTh>
                            <MudTh>Copies</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd>@vm.GetDocName(context.DocId)</MudTd>
                            <MudTd><MudText Typo="Typo.caption">@context.DocId</MudText></MudTd>
                            <MudTd>@context.OutputType</MudTd>
                            <MudTd>@context.DelieveryTypes</MudTd>
                            <MudTd>@context.DeliveryLoaction</MudTd>
                            <MudTd>@context.Copies</MudTd>
                        </RowTemplate>
                    </MudTable>
                }

                @if (vm.SelectedLoanAgreement?.AdminBench?.Trace is not null && vm.SelectedLoanAgreement.AdminBench.Trace.Count > 0)
                {
                    <MudExpansionPanels Class="mt-3">
                        <MudExpansionPanel Text="ThenGenerate Trace (Rules)" Expanded="false">
                            <MudList T="string" Dense="true">
                                @foreach (var line in vm.SelectedLoanAgreement.AdminBench.Trace)
                                {
                                    <MudListItem>
                                        <MudText Typo="Typo.caption">@line</MudText>
                                    </MudListItem>
                                }
                            </MudList>
                        </MudExpansionPanel>
                    </MudExpansionPanels>
                }
            </MudItem>

            <MudItem xs="12">
                <MudDivider Class="my-4" />
                <MudText Typo="Typo.subtitle1">Live Output (Merge Results)</MudText>

                @if (DocState.DocumentList.Count == 0)
                {
                    <MudText Typo="Typo.body2" Color="Color.Secondary">No merges yet.</MudText>
                }
                else
                {
                    <MudTable Items="DocState.DocumentList.Values.OrderByDescending(x => x.MergeCompleteAt ?? DateTime.MinValue)"
                              Dense="true" Hover="true">
                        <HeaderContent>
                            <MudTh>Status</MudTh>
                            <MudTh>Document</MudTh>
                            <MudTh>Completed</MudTh>
                            <MudTh>Bytes</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd>@context.Status</MudTd>
                            <MudTd>@(context.Document?.Name ?? "(no name)")</MudTd>
                            <MudTd>@(context.MergeCompleteAt?.ToLocalTime().ToString("g") ?? "")</MudTd>
                            <MudTd>@(context.MergedDocumentBytes?.Length ?? 0)</MudTd>
                        </RowTemplate>
                    </MudTable>
                }
            </MudItem>

        </MudGrid>
    </MudPaper>
</MudContainer>

@code {
    protected override async Task OnInitializedAsync()
    {
        await vm.InitializeAsync();
    }

    private async Task OnDocLibChanged()
    {
        await vm.ReloadAsync();
    }

    private async Task OnLoanChanged()
    {
        await vm.OnLoanAgreementChangedAsync();
    }

    private async Task OnLoanTypeChanged()
    {
        await vm.OnLoanTypeChangedAsync();
    }
}
