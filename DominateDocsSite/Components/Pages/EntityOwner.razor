﻿

@using System.Text;
@using DominateDocsData.Models;
@using System.Globalization;
@using System.Collections.ObjectModel;
@using DominateDocsData.Models.MergeDTOs;

@rendermode InteractiveServer
@inject EntityOwnerViewModel vm
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject EntityOwnerValidator EntityOwnerValidator
@inject UserSession Session


@if (displayList)
{
        <MudGrid Class="">

            <MudItem xs="12" md="12">

                <MudText Class="pl-4 ml-2" Typo="Typo.subtitle1">Owners: @vm.MyRecordList.Count </MudText>
                <MudTable Class="ml-4 mr-5" Style="background-color: var(--mud-palette-background);" Items="vm.MyRecordList" Context="context" Hover="true" Bordered="true" Dense="true" @bind-SelectedItem="vm.SelectedRecord" RowClick="OnSelectedRecord">
                    <HeaderContent>
                        <MudTh>Name</MudTh>
                        <MudTh>% Owner</MudTh>
                        <MudTh HeaderCellClass="text-right">
                            <MudButton Class="rounded-4"
                                       Disabled="@AddButtonDisabled"
                                       Variant="Variant.Text"
                                       Size="Size.Small"
                                       Color="Color.Primary"
                                       StartIcon="@Icons.Material.Filled.Add"
                                       OnClick="AddButton">
                                Add Entity Owner
                            </MudButton> 
                        </MudTh>

                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Name">@context.Name</MudTd>
                        <MudTd DataLabel="Alias">@context.Email</MudTd>
                        <MudTd DataLabel="Alias">@context.PercentOfOwnership</MudTd>

                        <MudTd>
                            <MudButton Variant="Variant.Text"
                                   Size="Size.Small"
                                   Color="Color.Info"
                                   StartIcon="@Icons.Material.Filled.Edit"
                                   OnClick="@(() => OnSelectedRecord(context))">
                                Edit
                            </MudButton>

                            <MudButton Variant="Variant.Text"
                                       Size="Size.Small"
                                       Color="Color.Error"
                                       StartIcon="@Icons.Material.Filled.Delete"
                                       OnClick="@(() => DeleteRecordAsync(context))">
                                Delete
                            </MudButton>      
                        </MudTd>
                    </RowTemplate>
                    @* <NoRecordsContent>
                        <MudText Color="Color.Secondary" Class="pa-4">
                            🚫 No Active Entity Owners Found. Please add!
                        </MudText>
                    </NoRecordsContent> *@

                </MudTable>

            </MudItem>

        </MudGrid>

}
else
{
        <MudGrid>

            <MudItem xs="12" md="12">

                <MudText Class="pl-4 mt-0" Typo="Typo.subtitle1">Entity Ownership</MudText>

                <MudForm Context="contextA" Model="@vm.EditingRecord" @ref="@form" Validation="@EntityOwnerValidator" ValidationDelay="0">
                    <MudGrid>
                        <MudItem md="6">
                            <div class="d-flex flex-column gap-2">
                                <MudTextField Class="pl-4" Variant="Variant.Outlined" Style="" @bind-Value="vm.EditingRecord.Name" Label="Name" Required="true" />

                                <MudTextField Class="pl-4" Variant="Variant.Outlined" Style="" @bind-Value="vm.EditingRecord.Email" Label="Email" Required="true" />
                                <MudTextField Class="pl-4" Variant="Variant.Outlined" Style="" @bind-Value="vm.EditingRecord.PhoneNumber" Label="Phone" Required="true" />
                                <MudTextField Class="pl-4" Variant="Variant.Outlined" Style="" @bind-Value="vm.EditingRecord.FullAddress" Label="Address" Required="true" />
                                <MudSelect Class="ml-4" T="DominateDocsData.Enums.Entity.ContactRoles" Style="" Variant="Variant.Outlined" Label="Select Entity Role" @bind-Value="vm.EditingRecord.EntityRole" Dense="true">

                                    @foreach (var gt in Enum.GetValues<DominateDocsData.Enums.Entity.ContactRoles>())
                                    {
                                        <MudSelectItem Style="" T="DominateDocsData.Enums.Entity.ContactRoles" Value="gt">@gt.GetDescription()</MudSelectItem>
                                    }

                                </MudSelect>

                                <MudNumericField T="decimal" Class="pl-4" Style="" Variant="Variant.Outlined" @bind-Value="vm.EditingRecord.PercentOfOwnership" Min="0" Max="100" Step="0.01m"
                                     Immediate="true" HideSpinButtons="true" Adornment="Adornment.End" AdornmentText="%" Required="true" Label="% of Ownership" Rules="@PercentRules" />

                                <MudStack Row="true" Spacing="10" Class="mt-4 mb-10">

                                    <MudButton Class="ml-10" Type="Submit" OnClick="HandleSubmit" Color="Color.Success" Variant="Variant.Filled">@(vm.SelectedRecord == null ? "Add" : "Save")</MudButton>
                                   
                                    <MudButton OnClick="ClearSelection" Color="Color.Secondary" Variant="Variant.Filled">Clear</MudButton>

                                </MudStack>
                            </div>

                        </MudItem>

                    </MudGrid>

                </MudForm>

            </MudItem>

        </MudGrid>

}



@code {

    [Parameter] public EventCallback<List<DominateDocsData.Models.EntityOwner>> OnEntityOwnerComplete { get; set; }
    [Parameter] public EventCallback OnEntityOwnerCanceled { get; set; }
    [Parameter] public List<DominateDocsData.Models.EntityOwner> OwnerList { get; set; }


    public decimal RatePercent { get; set; } = 7.5m;

    private IEnumerable<Func<decimal, string>> PercentRules => new Func<decimal, string>[] 
    {
            v => (v >= 0 && v <= 100) ? null : "Enter 0–100"
    };

    private MudForm form;

    private bool editRecord = false;
    private bool displayList = false;
    private bool AddButtonDisabled = false;

    private int editingIndex = -1;

    protected override async Task OnInitializedAsync()
    {
        vm.InitializeLoadPageCommand.Execute(OwnerList);

        displayList = true;
    }

    private async Task HandleSubmit()
    {
        await form.Validate();

        if (!form.IsValid)
        {
            Snackbar.Add("Please correct the errors in the form.", Severity.Error);
            return;
        }
        else
        {
            if (!editRecord)
            {

                if (vm.MyRecordList.Any(x => x.Name == vm.EditingRecord.Name))
                {
                    Snackbar.Add("A Duplicate Name can exists.", Severity.Error);

                    return;
                }
            }

            vm.UpsertRecordCommand.Execute(null);

            await OnEntityOwnerComplete.InvokeAsync(vm.MyRecordList.ToList());


            displayList = true;

            vm.GetNewRecordCommand.Execute(null);

            StateHasChanged();

            AddButtonDisabled = false;
        }
    }

    private async Task DeleteRecordAsync(DominateDocsData.Models.EntityOwner r)
    {
        vm.DeleteRecordCommand.Execute(r);

        vm.ClearSelectionCommand.Execute(null);

        editRecord = false;

        displayList = true;

        await OnEntityOwnerComplete.InvokeAsync(vm.MyRecordList.ToList());

        StateHasChanged();
    }

    private void ClearSelection()
    {
        vm.ClearSelectionCommand.Execute(null);
        StateHasChanged();
    }

    private void AddButton()
    {
        vm.GetNewRecordCommand.Execute(null);

        AddButtonDisabled = false;

        displayList = false;
    }

    private void OnSelectedRecord(DominateDocsData.Models.EntityOwner entityOwner)
    {

        if (entityOwner is not null) vm.SelectRecordCommand.Execute(entityOwner);

        editRecord = true;
        displayList = false;

    }

    private void CancelEdit()
    {
        editingIndex = -1;

        StateHasChanged();
    }

    



}