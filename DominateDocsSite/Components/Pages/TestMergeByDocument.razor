@page "/testmergebydocument"

@using MudBlazor
@using DominateDocsData.Enums
@using DominateDocsData.Models

@rendermode InteractiveServer

@inject DominateDocsSite.ViewModels.TestMergeViewModel vm
@inject ISnackbar Snackbar

<MudPaper Class="pa-4" Outlined="true">
    <MudText Typo="Typo.h5">Admin Test Merge Bench</MudText>
    <MudText Typo="Typo.caption" Class="mud-text-secondary mb-3">
        Pick a DocLibId (library), then test output evaluation or single-doc merges. This page is for you, not humans.
    </MudText>

    <MudGrid GutterSize="3">

        <!-- Library -->
        <MudItem xs="12" md="8">
            <MudSelect T="Guid" Label="Document Library (DocLibId)" Variant="Variant.Outlined" Dense="true"
                       @bind-Value="vm.SelectedDocLibId">
                @foreach (var id in vm.DocLibIds)
                {
                    <MudSelectItem Value="id">@id</MudSelectItem>
                }
            </MudSelect>
        </MudItem>

        <MudItem xs="12" md="4" Class="d-flex align-end" Style="gap:10px;">
            <MudButton Variant="Variant.Filled" Disabled="@vm.IsBusy" OnClick="ReloadClicked">
                Reload
            </MudButton>
            <MudButton Variant="Variant.Text" Color="Color.Secondary" Disabled="@vm.IsBusy" OnClick="ClearClicked">
                Clear
            </MudButton>
        </MudItem>

        <!-- Email + Output -->
        <MudItem xs="12" md="6">
            <MudTextField Label="Email To" Variant="Variant.Outlined" Dense="true"
                          @bind-Value="vm.EmailTo" />
        </MudItem>

        <MudItem xs="12" md="6">
            <MudSelect T="DocumentTypes.OutputTypes" Label="Output Type" Variant="Variant.Outlined" Dense="true"
                       @bind-Value="vm.OutputType">
                @foreach (var v in Enum.GetValues<DocumentTypes.OutputTypes>())
                {
                    <MudSelectItem Value="v">@v.GetDescription()</MudSelectItem>
                }
            </MudSelect>
        </MudItem>

        <MudItem xs="12">
            <MudDivider Class="my-2" />
        </MudItem>

        <!-- Mode -->
        <MudItem xs="12" md="6">
            <MudSelect T="DominateDocsSite.ViewModels.TestMergeViewModel.TestMode" Label="Mode"
                       Variant="Variant.Outlined" Dense="true"
                       @bind-Value="vm.Mode">
                <MudSelectItem Value="DominateDocsSite.ViewModels.TestMergeViewModel.TestMode.OutputEvaluation">
                    Output Evaluation (LoanType)
                </MudSelectItem>
                <MudSelectItem Value="DominateDocsSite.ViewModels.TestMergeViewModel.TestMode.SingleDocumentMerge">
                    Single Document Merge (ignore LoanType)
                </MudSelectItem>
            </MudSelect>
        </MudItem>

        <!-- Loan Agreement (unfiltered) -->
        <MudItem xs="12" md="6">
            <MudSelect T="LoanAgreement" Label="Loan Agreement" Variant="Variant.Outlined" Dense="true"
                       @bind-Value="vm.SelectedLoanAgreement">
                @foreach (var loan in vm.LoanAgreements)
                {
                    <MudSelectItem Value="loan">@vm.GetLoanLabel(loan)</MudSelectItem>
                }
            </MudSelect>

            <MudText Typo="Typo.caption" Class="mud-text-secondary mt-1">
                Agreements are not filtered by DocLibId (your DocLibId is down on lender/broker).
            </MudText>
        </MudItem>

        @if (vm.Mode == DominateDocsSite.ViewModels.TestMergeViewModel.TestMode.OutputEvaluation)
        {
            <MudItem xs="12" md="6">
                <MudSelect T="LoanType" Label="Loan Type" Variant="Variant.Outlined" Dense="true"
                           @bind-Value="vm.SelectedLoanType">
                    @foreach (var lt in vm.LoanTypes)
                    {
                        <MudSelectItem Value="lt">@lt.Name</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>

            <MudItem xs="12" md="6" Class="d-flex align-end" Style="gap:10px;">
                <MudButton Variant="Variant.Filled" Color="Color.Primary"
                           Disabled="@(!vm.CanEvaluate || vm.IsBusy)"
                           OnClick="EvaluateClicked">
                    Evaluate
                </MudButton>

                <MudButton Variant="Variant.Filled" Color="Color.Success"
                           Disabled="@(!vm.CanMergeEvaluated || vm.IsBusy)"
                           OnClick="MergeEvaluatedClicked">
                    Merge + Email Evaluated
                </MudButton>
            </MudItem>

            <MudItem xs="12">
                <MudText Typo="Typo.subtitle2" Class="mt-2">Evaluated Output Docs</MudText>
                <MudPaper Outlined="true" Class="pa-2">
                    @if (vm.EvaluatedDocs.Count == 0)
                    {
                        <MudText Typo="Typo.caption" Class="mud-text-secondary">No results.</MudText>
                    }
                    else
                    {
                        <div class="d-flex flex-wrap" style="gap:8px;">
                            @foreach (var d in vm.EvaluatedDocs)
                            {
                                <MudChip T="string" Variant="Variant.Outlined" Size="Size.Small">@d.Name</MudChip>
                            }
                        </div>
                    }
                </MudPaper>
            </MudItem>
        }
        else
        {
            <MudItem xs="12" md="6">
                <MudSelect T="DominateDocsData.Models.Document" Label="Document" Variant="Variant.Outlined" Dense="true"
                           @bind-Value="vm.SelectedDocument">
                    @foreach (var doc in vm.Documents)
                    {
                        <MudSelectItem Value="doc">@doc.Name</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>

            <MudItem xs="12" md="6" Class="d-flex align-end" Style="gap:10px;">
                <MudButton Variant="Variant.Filled" Color="Color.Success"
                           Disabled="@(!vm.CanMergeSingle || vm.IsBusy)"
                           OnClick="MergeSingleClicked">
                    Merge + Email Document
                </MudButton>
            </MudItem>
        }

        <MudItem xs="12">
            @if (!string.IsNullOrWhiteSpace(vm.Status))
            {
                <MudAlert Severity="Severity.Info" Dense="true">@vm.Status</MudAlert>
            }
        </MudItem>
    </MudGrid>
</MudPaper>

@code {

    protected override async Task OnInitializedAsync()
    {
        await vm.InitializeAsync();
    }

    private async Task ReloadClicked()
    {
        await vm.ReloadAsync();
    }

    private void ClearClicked()
    {
        vm.Clear();
        Snackbar.Add("Cleared.", Severity.Info);
    }

    private Task EvaluateClicked() => vm.EvaluateAsync();

    private Task MergeEvaluatedClicked() => vm.MergeEvaluatedAsync();

    private Task MergeSingleClicked() => vm.MergeSingleAsync();
}
